{% extends 'area_publica/base_form_publico.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ paroquia.PAR_nome_paroquia|default:"Paróquia" }} - Quero ser Dizimista{% endblock %}

{% block hero_icon %}<i class="fas fa-heart me-3"></i>{% endblock %}
{% block hero_title %}Quero ser Dizimista{% endblock %}
{% block hero_subtitle %}Cadastre-se para contribuir com nossa paróquia e fazer parte desta família de fé{% endblock %}

{% block form_id %}dizimistaForm{% endblock %}
{% block btn_submit_text %}Cadastrar como dizimista{% endblock %}

{% block form_content %}
<!-- Formulário do Dizimista -->
<form method="post" enctype="multipart/form-data" id="dizimistaForm" onsubmit="return lockFormButtons(this)">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            <h6>Erro ao cadastrar dizimista:</h6>
            {% for error in form.non_field_errors %}
                <div>{{ error }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- ESTRUTURA DA TELA-PAI (ÁREA ADMIN) -->
    <div class="row detalhe-dizimista">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label fw-bold">Telefone *</label>
                {% if telefone_readonly %}
                    {% if form.DIS_telefone.value %}
                        <input type="text" 
                               name="DIS_telefone" 
                               value="{{ form.DIS_telefone.value }}" 
                               class="form-control form-control" 
                               id="id_DIS_telefone" 
                               readonly 
                               style="background-color: #e9ecef;">
                    {% else %}
                        <input type="text" 
                               name="DIS_telefone" 
                               value="{{ telefone_url }}" 
                               class="form-control form-control" 
                               id="id_DIS_telefone" 
                               readonly 
                               style="background-color: #e9ecef;">
                    {% endif %}
                    <small class="text-muted">Telefone identificado automaticamente via WhatsApp</small>
                {% else %}
                    {{ form.DIS_telefone }}
                {% endif %}
                {% if form.DIS_telefone.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_telefone.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Nome Completo *</label>
                {{ form.DIS_nome }}
                {% if form.DIS_nome.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_nome.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">E-mail</label>
                {{ form.DIS_email }}
                {% if form.DIS_email.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_email.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Data de Nascimento</label>
                {{ form.DIS_data_nascimento }}
                {% if form.DIS_data_nascimento.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_data_nascimento.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Sexo</label>
                {{ form.DIS_sexo }}
                {% if form.DIS_sexo.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_sexo.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">CPF</label>
                {{ form.DIS_cpf }}
                {% if form.DIS_cpf.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_cpf.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Dia do Pagamento</label>
                {{ form.DIS_dia_pagamento }}
                {% if form.DIS_dia_pagamento.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_dia_pagamento.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                <small class="form-text text-muted">Dia do mês em que prefere fazer o pagamento (1-31)</small>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label fw-bold">CEP</label>
                {{ form.DIS_cep }}
                {% if form.DIS_cep.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_cep.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Endereço</label>
                {{ form.DIS_endereco }}
                {% if form.DIS_endereco.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_endereco.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Número</label>
                {{ form.DIS_numero }}
                {% if form.DIS_numero.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_numero.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Complemento</label>
                {{ form.DIS_complemento }}
                {% if form.DIS_complemento.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_complemento.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Bairro</label>
                {{ form.DIS_bairro }}
                {% if form.DIS_bairro.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_bairro.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Cidade</label>
                {{ form.DIS_cidade }}
                {% if form.DIS_cidade.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_cidade.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Estado</label>
                {{ form.DIS_estado }}
                {% if form.DIS_estado.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_estado.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Valor do Dízimo (R$)</label>
                {{ form.DIS_valor }}
                {% if form.DIS_valor.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_valor.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Foto</label>
                {{ form.DIS_foto }}
                {% if form.DIS_foto.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_foto.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                <div id="foto-preview" class="mt-2" style="display: none;">
                    <img id="preview-img" src="" alt="Preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js_module %}
<script>
// Função global para preencher endereço com CEP
window.buscarCep = function(conteudo) {
    console.log('buscarCep chamado com:', conteudo);
    if (!("erro" in conteudo)) {
        console.log('Preenchendo endereço...');
        
        // Tentar encontrar os campos usando vários métodos
        var endereco = document.getElementById('id_DIS_endereco') || 
                      document.getElementById('DIS_endereco') ||
                      document.querySelector('[name="DIS_endereco"]');
        var bairro = document.getElementById('id_DIS_bairro') || 
                    document.getElementById('DIS_bairro') ||
                    document.querySelector('[name="DIS_bairro"]');
        var cidade = document.getElementById('id_DIS_cidade') || 
                     document.getElementById('DIS_cidade') ||
                     document.querySelector('[name="DIS_cidade"]');
        var estado = document.getElementById('id_DIS_estado') || 
                    document.getElementById('DIS_estado') ||
                    document.querySelector('[name="DIS_estado"]');
        
        console.log('Campos encontrados:', !!endereco, !!bairro, !!cidade, !!estado);
        
        if (endereco) {
            endereco.value = conteudo.logradouro || '';
            console.log('Endereço preenchido:', conteudo.logradouro);
        }
        if (bairro) {
            bairro.value = conteudo.bairro || '';
            console.log('Bairro preenchido:', conteudo.bairro);
        }
        if (cidade) {
            cidade.value = conteudo.localidade || '';
            console.log('Cidade preenchida:', conteudo.localidade);
        }
        if (estado) {
            estado.value = conteudo.uf || '';
            console.log('Estado preenchido:', conteudo.uf);
        }
        
//        alert('CEP encontrado! Endereço preenchido.');
    } else {
        console.log('CEP não encontrado');
        alert('CEP não encontrado');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('Página carregada - iniciando configuração');
    
    // Configurar tabindex na ordem correta: Telefone, Nome, E-mail, Data Nascimento, Sexo, CPF, Dia Pagamento, CEP, Endereço, Número, Complemento, Bairro, Cidade, Estado, Valor, Foto
    var campos = [
        'DIS_telefone', 'DIS_nome', 'DIS_email', 'DIS_data_nascimento', 
        'DIS_sexo', 'DIS_cpf', 'DIS_dia_pagamento', 'DIS_cep', 'DIS_endereco', 
        'DIS_numero', 'DIS_complemento', 'DIS_bairro', 'DIS_cidade', 
        'DIS_estado', 'DIS_valor', 'DIS_foto'
    ];
    
    campos.forEach(function(campoName, index) {
        var campo = document.getElementById('id_' + campoName) || 
                    document.getElementById(campoName) ||
                    document.querySelector('[name="' + campoName + '"]');
        if (campo) {
            campo.setAttribute('tabindex', index + 1);
            console.log('Tabindex', index + 1, 'aplicado ao', campoName);
        } else {
            console.warn('Campo não encontrado:', campoName);
        }
    });
    
    // CEP - tentar encontrar o campo CEP de várias formas
    var cepInput = document.getElementById('id_DIS_cep') || 
                   document.getElementById('DIS_cep') ||
                   document.querySelector('[name="DIS_cep"]');
    
    console.log('Campo CEP encontrado:', cepInput);
    
    if (cepInput) {
        console.log('Adicionando eventos ao CEP');
        
        // Máscara de CEP
        cepInput.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 8) {
                value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
            }
            e.target.value = value;
        });
        
        // Buscar CEP ao sair do campo
        cepInput.addEventListener('blur', function() {
            var cep = this.value.replace(/\D/g, '');
            console.log('BLUR - Buscando CEP:', cep);
            
            if (cep.length === 8) {
                console.log('CEP válido, fazendo requisição...');
                var script = document.createElement('script');
                script.src = 'https://viacep.com.br/ws/' + cep + '/json/?callback=buscarCep';
                script.onload = function() { console.log('Script carregado'); };
                script.onerror = function() { console.log('Erro ao carregar script'); };
                document.body.appendChild(script);
            } else {
                console.log('CEP inválido, tamanho:', cep.length);
            }
        });
    } else {
        console.error('Campo CEP não encontrado');
    }
    
    // CPF - Máscara de CPF
    var cpfInput = document.getElementById('id_DIS_cpf') || 
                   document.getElementById('DIS_cpf') ||
                   document.querySelector('[name="DIS_cpf"]');
    
    if (cpfInput) {
        console.log('Adicionando máscara ao CPF');
        cpfInput.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                value = value.substring(0, 14);
            }
            e.target.value = value;
        });
    }
    
    // Telefone - Máscara de telefone
    var telefoneInput = document.getElementById('id_DIS_telefone') || 
                       document.getElementById('DIS_telefone') ||
                       document.querySelector('[name="DIS_telefone"]');
    
    if (telefoneInput) {
        console.log('Adicionando máscara ao Telefone');
        telefoneInput.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length <= 10) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                } else {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
            }
            e.target.value = value.substring(0, 15);
        });
    }
});
</script>
{% endblock %}
