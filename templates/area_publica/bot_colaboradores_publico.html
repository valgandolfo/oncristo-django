{% extends 'area_publica/base_form_publico.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ paroquia.PAR_nome_paroquia|default:"Paróquia" }} - Quero ser Colaborador{% endblock %}

{% block hero_icon %}<i class="fas fa-user-friends me-3"></i>{% endblock %}
{% block hero_title %}Quero ser Colaborador{% endblock %}
{% block hero_subtitle %}Cadastre-se para colaborar com nossa paróquia e fazer parte desta família de fé{% endblock %}

{% block form_id %}colaboradorForm{% endblock %}
{% block btn_submit_text %}Cadastrar como colaborador{% endblock %}

{% block form_content %}
<!-- Mensagens (para cadastro público, mostrar mesmo sem login) -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="display: none;" id="message-{{ forloop.counter }}">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endif %}

<!-- Formulário do Colaborador -->
<form method="post" enctype="multipart/form-data" id="colaboradorForm" onsubmit="return lockFormButtons(this)">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            <h6>Erro ao cadastrar colaborador:</h6>
            {% for error in form.non_field_errors %}
                <div>{{ error }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- ESTRUTURA DA TELA-PAI (ÁREA ADMIN) -->
    <div class="row detalhe-colaborador">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label fw-bold">Telefone *</label>
                {% if telefone_readonly %}
                    {% if form.COL_telefone.value %}
                        <input type="text" 
                               name="COL_telefone" 
                               value="{{ form.COL_telefone.value }}" 
                               class="form-control form-control" 
                               id="id_COL_telefone" 
                               readonly 
                               style="background-color: #e9ecef;">
                    {% else %}
                        <input type="text" 
                               name="COL_telefone" 
                               value="{{ telefone_url }}" 
                               class="form-control form-control" 
                               id="id_COL_telefone" 
                               readonly 
                               style="background-color: #e9ecef;">
                    {% endif %}
                    <small class="text-muted">Telefone identificado automaticamente via WhatsApp</small>
                {% else %}
                    {{ form.COL_telefone }}
                {% endif %}
                {% if form.COL_telefone.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_telefone.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Nome Completo *</label>
                {{ form.COL_nome_completo }}
                {% if form.COL_nome_completo.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_nome_completo.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Apelido</label>
                {{ form.COL_apelido }}
                {% if form.COL_apelido.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_apelido.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Data de Nascimento</label>
                {{ form.COL_data_nascimento }}
                {% if form.COL_data_nascimento.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_data_nascimento.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Sexo</label>
                {{ form.COL_sexo }}
                {% if form.COL_sexo.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_sexo.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Estado Civil</label>
                {{ form.COL_estado_civil }}
                {% if form.COL_estado_civil.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_estado_civil.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Função Pretendida</label>
                {{ form.COL_funcao_pretendida }}
                {% if form.COL_funcao_pretendida.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_funcao_pretendida.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label fw-bold">CEP</label>
                {{ form.COL_cep }}
                {% if form.COL_cep.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_cep.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Endereço</label>
                {{ form.COL_endereco }}
                {% if form.COL_endereco.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_endereco.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Número</label>
                {{ form.COL_numero }}
                {% if form.COL_numero.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_numero.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Complemento</label>
                {{ form.COL_complemento }}
                {% if form.COL_complemento.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_complemento.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Bairro</label>
                {{ form.COL_bairro }}
                {% if form.COL_bairro.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_bairro.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Cidade</label>
                {{ form.COL_cidade }}
                {% if form.COL_cidade.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_cidade.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Estado</label>
                {{ form.COL_estado }}
                {% if form.COL_estado.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_estado.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Foto</label>
                {{ form.COL_foto }}
                {% if form.COL_foto.errors %}
                    <div class="text-danger small">
                        {% for error in form.COL_foto.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                <div id="foto-preview" class="mt-2" style="display: none;">
                    <img id="preview-img" src="" alt="Preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js_module %}
<script>
// Função global para preencher endereço com CEP
window.buscarCep = function(conteudo) {
    console.log('buscarCep chamado com:', conteudo);
    if (!("erro" in conteudo)) {
        console.log('Preenchendo endereço...');
        
        // Tentar encontrar os campos usando vários métodos
        var endereco = document.getElementById('id_COL_endereco') || 
                      document.getElementById('COL_endereco') ||
                      document.querySelector('[name="COL_endereco"]');
        var bairro = document.getElementById('id_COL_bairro') || 
                    document.getElementById('COL_bairro') ||
                    document.querySelector('[name="COL_bairro"]');
        var cidade = document.getElementById('id_COL_cidade') || 
                     document.getElementById('COL_cidade') ||
                     document.querySelector('[name="COL_cidade"]');
        var estado = document.getElementById('id_COL_estado') || 
                    document.getElementById('COL_estado') ||
                    document.querySelector('[name="COL_estado"]');
        
        console.log('Campos encontrados:', !!endereco, !!bairro, !!cidade, !!estado);
        
        if (endereco) {
            endereco.value = conteudo.logradouro || '';
            console.log('Endereço preenchido:', conteudo.logradouro);
        }
        if (bairro) {
            bairro.value = conteudo.bairro || '';
            console.log('Bairro preenchido:', conteudo.bairro);
        }
        if (cidade) {
            cidade.value = conteudo.localidade || '';
            console.log('Cidade preenchida:', conteudo.localidade);
        }
        if (estado) {
            estado.value = conteudo.uf || '';
            console.log('Estado preenchido:', conteudo.uf);
        }
    } else {
        console.log('CEP não encontrado');
        alert('CEP não encontrado');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('Página carregada - iniciando configuração');
    
    // CEP - tentar encontrar o campo CEP de várias formas
    var cepInput = document.getElementById('id_COL_cep') || 
                   document.getElementById('COL_cep') ||
                   document.querySelector('[name="COL_cep"]');
    
    console.log('Campo CEP encontrado:', cepInput);
    
    if (cepInput) {
        console.log('Adicionando eventos ao CEP');
        
        // Máscara de CEP
        cepInput.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 8) {
                value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
            }
            e.target.value = value;
        });
        
        // Buscar CEP ao sair do campo
        cepInput.addEventListener('blur', function() {
            var cep = this.value.replace(/\D/g, '');
            console.log('BLUR - Buscando CEP:', cep);
            
            if (cep.length === 8) {
                console.log('CEP válido, fazendo requisição...');
                var script = document.createElement('script');
                script.src = 'https://viacep.com.br/ws/' + cep + '/json/?callback=buscarCep';
                script.onload = function() { console.log('Script carregado'); };
                script.onerror = function() { console.log('Erro ao carregar script'); };
                document.body.appendChild(script);
            } else {
                console.log('CEP inválido, tamanho:', cep.length);
            }
        });
    } else {
        console.error('Campo CEP não encontrado');
    }
    
    // Telefone - Máscara de telefone
    var telefoneInput = document.getElementById('id_COL_telefone') || 
                       document.getElementById('COL_telefone') ||
                       document.querySelector('[name="COL_telefone"]');
    
    if (telefoneInput && !telefoneInput.readOnly) {
        console.log('Adicionando máscara ao Telefone');
        telefoneInput.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length <= 10) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                } else {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
            }
            e.target.value = value.substring(0, 15);
        });
    }
    
    // Preview de foto
    var fotoInput = document.getElementById('id_COL_foto') || 
                   document.getElementById('COL_foto') ||
                   document.querySelector('[name="COL_foto"]');
    var fotoPreview = document.getElementById('foto-preview');
    var previewImg = document.getElementById('preview-img');
    
    if (fotoInput && fotoPreview && previewImg) {
        fotoInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    fotoPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                fotoPreview.style.display = 'none';
            }
        });
    }
    
    // Loading e redirecionamento após sucesso
    var form = document.getElementById('colaboradorForm');
    var submitBtn = form.querySelector('button[type="submit"]') || form.querySelector('input[type="submit"]');
    var originalBtnText = submitBtn ? submitBtn.innerHTML || submitBtn.value : '';
    
    // Criar overlay de loading
    var loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'loading-overlay';
    loadingOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
    `;
    loadingOverlay.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center; max-width: 400px;">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <h5 style="color: #2c5530; margin-bottom: 10px;">Aguarde...</h5>
            <p style="color: #666; margin: 0;">Estamos providenciando seu cadastro.</p>
            <p style="color: #999; font-size: 0.9em; margin-top: 5px;">Isso pode levar alguns instantes.</p>
        </div>
    `;
    document.body.appendChild(loadingOverlay);
    
    // Interceptar submit do formulário
    if (form) {
        form.addEventListener('submit', function(e) {
            // Mostrar loading
            loadingOverlay.style.display = 'flex';
            
            // Desabilitar botão de submit
            if (submitBtn) {
                submitBtn.disabled = true;
                if (submitBtn.innerHTML) {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
                } else if (submitBtn.value) {
                    submitBtn.value = 'Enviando...';
                }
            }
        });
    }
    
    // Verificar se há mensagem de sucesso (do Django messages)
    var successMessages = document.querySelectorAll('.alert-success');
    if (successMessages.length > 0) {
        // Ocultar overlay de loading se estiver visível
        loadingOverlay.style.display = 'none';
        
        // Pegar o texto da mensagem
        var messageText = successMessages[0].textContent.trim();
        
        // Mostrar modal de sucesso
        var successModal = document.createElement('div');
        successModal.id = 'success-modal';
        successModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        successModal.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 10px; text-align: center; max-width: 500px; margin: 20px;">
                <div style="color: #28a745; font-size: 4em; margin-bottom: 20px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h4 style="color: #2c5530; margin-bottom: 15px;">Cadastro Realizado com Sucesso!</h4>
                <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">${messageText}</p>
                <button onclick="window.location.href='{{ url_retorno|default:'/' }}'" style="
                    background-color: #2c5530;
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 5px;
                    font-size: 16px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: background-color 0.3s;
                " onmouseover="this.style.backgroundColor='#1e3a21'" onmouseout="this.style.backgroundColor='#2c5530'">
                    OK
                </button>
            </div>
        `;
        document.body.appendChild(successModal);
        
        // Ocultar mensagens de alerta padrão
        successMessages.forEach(function(msg) {
            msg.style.display = 'none';
        });
    }
});
</script>
{% endblock %}





