{% extends 'area_publica/base_form_publico.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ paroquia.PAR_nome_paroquia|default:"Paróquia" }} - Cadastro de Dizimista{% endblock %}

{% block hero_icon %}<i class="fas fa-heart me-3"></i>{% endblock %}
{% block hero_title %}Cadastro de Dizimista{% endblock %}
{% block hero_subtitle %}Cadastre-se para contribuir com nossa paróquia e fazer parte desta família de fé{% endblock %}

{% block form_id %}dizimistaForm{% endblock %}
{% block btn_submit_text %}Cadastrar como dizimista{% endblock %}

{% block form_content %}
<!-- Formulário do Dizimista (mesma estrutura do bot_dizimistas_publico; diferença: bot vem do WhatsApp com telefone automático) -->
<form method="post" enctype="multipart/form-data" id="dizimistaForm" onsubmit="return lockFormButtons(this)">
    {% csrf_token %}
    
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            <h6>Erro ao cadastrar dizimista:</h6>
            {% for error in form.non_field_errors %}
                <div>{{ error }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row detalhe-dizimista">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label fw-bold">Telefone *</label>
                {% if telefone_readonly %}
                    {% if form.DIS_telefone.value %}
                        <input type="text" 
                               name="DIS_telefone" 
                               value="{{ form.DIS_telefone.value }}" 
                               class="form-control form-control" 
                               id="id_DIS_telefone" 
                               readonly 
                               style="background-color: #e9ecef;">
                    {% else %}
                        <input type="text" 
                               name="DIS_telefone" 
                               value="{{ telefone_url }}" 
                               class="form-control form-control" 
                               id="id_DIS_telefone" 
                               readonly 
                               style="background-color: #e9ecef;">
                    {% endif %}
                    <small class="text-muted">Telefone identificado automaticamente via WhatsApp</small>
                {% else %}
                    {{ form.DIS_telefone }}
                    <div id="telefone-feedback" class="mt-1"></div>
                {% endif %}
                {% if form.DIS_telefone.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_telefone.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Nome Completo *</label>
                {{ form.DIS_nome }}
                {% if form.DIS_nome.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_nome.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">E-mail</label>
                {{ form.DIS_email }}
                {% if form.DIS_email.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_email.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Data de Nascimento</label>
                {{ form.DIS_data_nascimento }}
                {% if form.DIS_data_nascimento.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_data_nascimento.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Sexo</label>
                {{ form.DIS_sexo }}
                {% if form.DIS_sexo.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_sexo.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">CPF</label>
                {{ form.DIS_cpf }}
                {% if form.DIS_cpf.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_cpf.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Dia do Pagamento</label>
                {{ form.DIS_dia_pagamento }}
                {% if form.DIS_dia_pagamento.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_dia_pagamento.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                <small class="form-text text-muted">Dia do mês em que prefere fazer o pagamento (1-31)</small>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label fw-bold">CEP</label>
                {{ form.DIS_cep }}
                {% if form.DIS_cep.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_cep.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Endereço</label>
                {{ form.DIS_endereco }}
                {% if form.DIS_endereco.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_endereco.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Número</label>
                {{ form.DIS_numero }}
                {% if form.DIS_numero.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_numero.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Complemento</label>
                {{ form.DIS_complemento }}
                {% if form.DIS_complemento.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_complemento.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Bairro</label>
                {{ form.DIS_bairro }}
                {% if form.DIS_bairro.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_bairro.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Cidade</label>
                {{ form.DIS_cidade }}
                {% if form.DIS_cidade.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_cidade.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Estado</label>
                {{ form.DIS_estado }}
                {% if form.DIS_estado.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_estado.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Valor do Dízimo (R$)</label>
                {{ form.DIS_valor }}
                {% if form.DIS_valor.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_valor.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Foto</label>
                {{ form.DIS_foto }}
                {% if form.DIS_foto.errors %}
                    <div class="text-danger small">
                        {% for error in form.DIS_foto.errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                <div id="foto-preview" class="mt-2" style="display: none;">
                    <img id="preview-img" src="" alt="Preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js_module %}
<script>
// Função global para preencher endereço com CEP (ViaCEP JSONP)
window.buscarCep = function(conteudo) {
    if (!("erro" in conteudo)) {
        var endereco = document.getElementById('id_DIS_endereco') || 
                      document.getElementById('DIS_endereco') ||
                      document.querySelector('[name="DIS_endereco"]');
        var bairro = document.getElementById('id_DIS_bairro') || 
                    document.getElementById('DIS_bairro') ||
                    document.querySelector('[name="DIS_bairro"]');
        var cidade = document.getElementById('id_DIS_cidade') || 
                     document.getElementById('DIS_cidade') ||
                     document.querySelector('[name="DIS_cidade"]');
        var estado = document.getElementById('id_DIS_estado') || 
                    document.getElementById('DIS_estado') ||
                    document.querySelector('[name="DIS_estado"]');
        
        if (endereco) endereco.value = conteudo.logradouro || '';
        if (bairro) bairro.value = conteudo.bairro || '';
        if (cidade) cidade.value = conteudo.localidade || '';
        if (estado) estado.value = conteudo.uf || '';
    } else {
        alert('CEP não encontrado');
    }
};

document.addEventListener('DOMContentLoaded', function() {
    // Tabindex na ordem dos campos
    var campos = [
        'DIS_telefone', 'DIS_nome', 'DIS_email', 'DIS_data_nascimento', 
        'DIS_sexo', 'DIS_cpf', 'DIS_dia_pagamento', 'DIS_cep', 'DIS_endereco', 
        'DIS_numero', 'DIS_complemento', 'DIS_bairro', 'DIS_cidade', 
        'DIS_estado', 'DIS_valor', 'DIS_foto'
    ];
    campos.forEach(function(campoName, index) {
        var campo = document.getElementById('id_' + campoName) || 
                    document.getElementById(campoName) ||
                    document.querySelector('[name="' + campoName + '"]');
        if (campo) campo.setAttribute('tabindex', index + 1);
    });
    
    // CEP: máscara e busca ViaCEP
    var cepInput = document.getElementById('id_DIS_cep') || 
                   document.getElementById('DIS_cep') ||
                   document.querySelector('[name="DIS_cep"]');
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 8) value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
            e.target.value = value;
        });
        cepInput.addEventListener('blur', function() {
            var cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                var script = document.createElement('script');
                script.src = 'https://viacep.com.br/ws/' + cep + '/json/?callback=buscarCep';
                document.body.appendChild(script);
            }
        });
    }
    
    // CPF: máscara
    var cpfInput = document.getElementById('id_DIS_cpf') || 
                   document.getElementById('DIS_cpf') ||
                   document.querySelector('[name="DIS_cpf"]');
    if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                value = value.substring(0, 14);
            }
            e.target.value = value;
        });
    }
    
    // Telefone: máscara (quando não readonly)
    var telefoneInput = document.getElementById('id_DIS_telefone') || 
                       document.getElementById('DIS_telefone') ||
                       document.querySelector('[name="DIS_telefone"]');
    if (telefoneInput && !telefoneInput.readOnly) {
        telefoneInput.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length <= 10) value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                else value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            e.target.value = value.substring(0, 15);
        });
    }
    
    // Verificar telefone (quando não readonly) - AJAX
    {% if not telefone_readonly %}
    var telInput = document.getElementById('id_DIS_telefone') || document.querySelector('[name="DIS_telefone"]');
    var feedback = document.getElementById('telefone-feedback');
    if (telInput && feedback) {
        telInput.addEventListener('blur', function() {
            var telefone = this.value;
            if (!telefone) { feedback.innerHTML = ''; return; }
            fetch('{% url "app_igreja:verificar_telefone_ajax" %}?telefone=' + encodeURIComponent(telefone))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.existe) {
                        feedback.innerHTML = '<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Este telefone já está cadastrado</small>';
                    } else {
                        feedback.innerHTML = '<small class="text-success"><i class="fas fa-check me-1"></i>Telefone disponível</small>';
                    }
                })
                .catch(function() {
                    feedback.innerHTML = '<small class="text-warning">Não foi possível verificar o telefone</small>';
                });
        });
    }
    {% endif %}
    
    // Estado em maiúscula
    var estadoInput = document.getElementById('id_DIS_estado') || document.querySelector('[name="DIS_estado"]');
    if (estadoInput) {
        estadoInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }
    
    // Preview da foto
    var fotoInput = document.getElementById('id_DIS_foto') || document.querySelector('[name="DIS_foto"]');
    var previewImg = document.getElementById('preview-img');
    var previewDiv = document.getElementById('foto-preview');
    if (fotoInput && previewImg && previewDiv) {
        fotoInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                var reader = new FileReader();
                reader.onload = function(ev) {
                    previewImg.src = ev.target.result;
                    previewDiv.style.display = 'block';
                };
                reader.readAsDataURL(e.target.files[0]);
            } else {
                previewDiv.style.display = 'none';
            }
        });
    }
});

function lockFormButtons(form) {
    var f = typeof form === 'object' && form.tagName === 'FORM' ? form : document.getElementById('dizimistaForm');
    if (!f) return true;
    // Só travar e enviar se o form for válido; senão o botão ficaria desabilitado sem enviar (loop/stuck)
    if (f.checkValidity && !f.checkValidity()) {
        if (f.reportValidity) f.reportValidity();
        return false;
    }
    var btn = document.querySelector('.btn-gravar-global');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Cadastrando...';
    }
    return true;
}
</script>
{% endblock %}
