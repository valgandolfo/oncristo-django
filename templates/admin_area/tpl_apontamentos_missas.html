{% extends 'base.html' %}
{% load static %}
{% load format_utils %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/configuracoes-visuais.css' %}">
<style>
/* CSS específico do módulo Apontamentos Escala Missa */
.panel-container_estatistica {
    display: none !important;
}

.icone-enviar {
    cursor: pointer;
    color: #28a745;
    font-size: 1.1rem;
    transition: all 0.2s ease;
}

.icone-enviar:hover {
    color: #218838;
    transform: scale(1.1);
}

.icone-enviar.disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

.icone-enviar.disabled:hover {
    transform: none;
}

.icone-editar, .icone-check {
    cursor: pointer;
    font-size: 1.1rem;
    transition: all 0.2s ease;
}

.icone-editar {
    color: #007bff;
}

.icone-editar:hover {
    color: #0056b3;
    transform: scale(1.1);
}

.icone-check {
    color: #28a745;
}

.icone-check:hover {
    color: #218838;
    transform: scale(1.1);
}

.select-grupo, .select-status {
    font-size: 0.875rem;
    padding: 4px 8px;
}

.grupo-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.grupo-select-wrapper {
    display: none;
}

.grupo-select-wrapper.editing {
    display: block;
}

/* Estilo para itens bloqueados */
tr.item-bloqueado {
    background-color: #f8d7da !important;
    opacity: 0.7;
}

tr.item-bloqueado td {
    color: #721c24;
}

tr.item-bloqueado:hover {
    background-color: #f5c6cb !important;
}

/* Estilo para campos de período no modal */
.campo-periodo {
    display: none;
    margin-bottom: 20px;
}

.campo-periodo.visivel {
    display: block;
}

.campo-periodo .campos-data {
    display: flex;
    gap: 15px;
    align-items: center;
}

.campo-periodo .campos-data > div {
    flex: 1;
}

.campo-periodo input[type="number"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}
</style>
{% endblock %}

{% block title %}Apontamentos Escala Missa{% endblock %}

<!-- === BLOCO DASHBOARD === -->
{% block icone_dashboard %}fas fa-tasks{% endblock %}
{% block nome_modulo_dashboard %}Apontamentos Escala Missa{% endblock %}
{% block url_retornar_dashboard %}{% url 'app_igreja:admin_area' %}{% endblock %}
{% block url_criar_novo_dashboard %}#{% endblock %}
{% block nome_modulo_lista_dashboard %}Itens da Escala{% endblock %}

<!-- === BLOCO ESTATÍSTICAS DASHBOARD === -->
{% block estatisticas_dashboard %}
<!-- PAINEL DE ESTATÍSTICAS OCULTO -->
{% endblock %}

<!-- === BLOCO BUSCA DASHBOARD === -->
{% block busca_dashboard %}
<form method="get" class="busca-campos">
    <div class="campo-busca">
        <label for="mes">Mês</label>
        <select id="mes" name="mes" required>
            {% opcoes_mes mes incluir_todos=True %}
        </select>
    </div>
    <div class="campo-busca">
        <label for="ano">Ano</label>
        <input type="number" id="ano" name="ano" value="{{ ano|default:'' }}" placeholder="Ex: 2026" min="2000" max="2100" required>
    </div>
    <button type="submit" class="cont_busca_btnbusca"><i class="fas fa-search"></i></button>
</form>
{% endblock %}

{% block conteudo_listagem_dashboard %}
{% if page_obj %}
    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <thead class="table-dark">
                <tr>
                    {% block colunas_cabecalho_dashboard %}
                    <th width="8%">Dia</th>
                    <th width="12%">Dia Semana</th>
                    <th width="8%">Hora</th>
                    <th width="20%">Encargo</th>
                    <th width="15%">Colaborador</th>
                    <th width="10%">Grupo</th>
                    <th width="10%">Status</th>
                    <th width="5%">J</th>
                    <th width="2%">Ação</th>
                    {% endblock %}
                </tr>
            </thead>
            <tbody>
                {% block linhas_tabela_dashboard %}
                {% if sem_filtro %}
                <tr>
                    <td colspan="9" class="text-center text-muted py-5">
                        <i class="fas fa-calendar-alt fa-2x mb-3"></i><br>
                        Informe o Mês e Ano para carregar a escala.
                    </td>
                </tr>
                {% else %}
                {% for item in page_obj %}
                <tr class="{% if not item.ITE_ESC_SITUACAO %}item-bloqueado{% endif %}" data-situacao="{{ item.ITE_ESC_SITUACAO|yesno:'true,false' }}">
                    <td data-data-item="{{ item.ITE_ESC_DATA|date:'Y-m-d' }}">{{ item.ITE_ESC_DATA|date:"d/M" }}</td>
                    <td>{{ item.dia_semana_nome|default:"-" }}</td>
                    <td data-horario-item="{{ item.ITE_ESC_HORARIO|time:'H:i' }}">{{ item.ITE_ESC_HORARIO|time:"H:i" }}</td>
                    <td>{{ item.ITE_ESC_ENCARGO|default:"-" }}</td>
                    <td data-colaborador-id="{{ item.ITE_ESC_COLABORADOR|default:'' }}" id="colaborador_{{ item.ITE_ESC_ID }}">{{ item.colaborador_nome|default:"-" }}</td>
                    <td>
                        <div class="grupo-container" id="container_grupo_{{ item.ITE_ESC_ID }}">
                            <!-- Sempre mostrar nome do grupo -->
                                <span id="nome_grupo_{{ item.ITE_ESC_ID }}">{{ item.grupo_nome|default:"-" }}</span>
                            
                            <!-- Modo edição: select + check (inicialmente oculto) -->
                            <div class="grupo-select-wrapper" id="wrapper_grupo_{{ item.ITE_ESC_ID }}">
                                <select class="form-control form-control-sm select-grupo" 
                                        data-item-id="{{ item.ITE_ESC_ID }}"
                                        id="grupo_{{ item.ITE_ESC_ID }}"
                                        style="min-width: 120px; font-size: 0.875rem; display: inline-block;">
                                    <option value="">Selecione...</option>
                                    {% if grupos %}
                                        {% for grupo in grupos %}
                                        <option value="{{ grupo.GRU_id }}" {% if item.ITE_ESC_GRUPO == grupo.GRU_id %}selected{% endif %}>
                                            {{ grupo.GRU_nome_grupo }}
                                        </option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <i class="fas fa-check-circle icone-check" 
                                   data-item-id="{{ item.ITE_ESC_ID }}"
                                   title="Salvar grupo"
                                   style="margin-left: 8px;"></i>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="grupo-container" id="container_status_{{ item.ITE_ESC_ID }}">
                            <!-- Sempre mostrar status atual -->
                                <span id="nome_status_{{ item.ITE_ESC_ID }}">
                                    {% if item.ITE_ESC_STATUS == 'DEFINIDO' %}Definido
                                    {% elif item.ITE_ESC_STATUS == 'RESERVADO' %}Reservado
                                    {% else %}Em Aberto{% endif %}
                                </span>
                            
                            <!-- Modo edição: select + check (inicialmente oculto) -->
                            <div class="grupo-select-wrapper" id="wrapper_status_{{ item.ITE_ESC_ID }}">
                                <select class="form-control form-control-sm select-status" 
                                        data-item-id="{{ item.ITE_ESC_ID }}"
                                        id="status_{{ item.ITE_ESC_ID }}"
                                        style="min-width: 120px; font-size: 0.875rem; display: inline-block;">
                                    <option value="EM_ABERTO" {% if item.ITE_ESC_STATUS == 'EM_ABERTO' %}selected{% endif %}>Em Aberto</option>
                                    <option value="RESERVADO" {% if item.ITE_ESC_STATUS == 'RESERVADO' %}selected{% endif %}>Reservado</option>
                                    <option value="DEFINIDO" {% if item.ITE_ESC_STATUS == 'DEFINIDO' %}selected{% endif %}>Definido</option>
                                </select>
                                <i class="fas fa-check-circle icone-check-status" 
                                   data-item-id="{{ item.ITE_ESC_ID }}"
                                   title="Salvar status"
                                   style="margin-left: 8px;"></i>
                            </div>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        {% if item.ITE_ESC_JANELA %}
                            {% if item.ITE_ESC_JANELA == 1 %}
                                <span title="Todas Leituras" style="font-weight: bold; color: #28a745;">1</span>
                            {% elif item.ITE_ESC_JANELA == 2 %}
                                <span title="Diferente da escolha Anterior" style="font-weight: bold; color: #ffc107;">2</span>
                            {% elif item.ITE_ESC_JANELA == 3 %}
                                <span title="Diferente das últimas duas escolhidas" style="font-weight: bold; color: #dc3545;">3</span>
                            {% else %}
                                <span>-</span>
                            {% endif %}
                        {% else %}
                            <span>-</span>
                        {% endif %}
                    </td>
                    <td>
                        <i class="fas fa-pencil-alt icone-enviar" 
                               data-item-id="{{ item.ITE_ESC_ID }}"
                           data-colaborador-nome="{{ item.colaborador_nome|default:'' }}"
                           data-encargo="{{ item.ITE_ESC_ENCARGO|default:'' }}"
                           data-data="{{ item.ITE_ESC_DATA|date:'d' }}"
                           data-dia-semana="{{ item.dia_semana_nome|default:'' }}"
                           data-horario="{{ item.ITE_ESC_HORARIO|time:'H:i' }}"
                           data-grupo-atual="{{ item.ITE_ESC_GRUPO|default:'' }}"
                           data-status-atual="{{ item.ITE_ESC_STATUS|default:'EM_ABERTO' }}"
                           title="Editar apontamento"
                           style="cursor: pointer; color: #007bff; font-size: 1.1rem;"></i>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center text-muted py-5">
                        <i class="fas fa-calendar-alt fa-2x mb-3"></i><br>
                        Nenhum item encontrado para {{ mes_nome }}/{{ ano }}.
                    </td>
                </tr>
                {% endfor %}
                {% endif %}
                {% endblock %}
            </tbody>
        </table>
    </div>

    <!-- Paginação padrão -->
    {% if page_obj.has_other_pages %}
    <div class="pagination-container">
        <ul class="pagination">
            {% if page_obj.has_previous %}
            <li><a href="?page=1{% if mes %}&mes={{ mes }}{% endif %}{% if ano %}&ano={{ ano }}{% endif %}">&laquo; Primeira</a></li>
            <li><a href="?page={{ page_obj.previous_page_number }}{% if mes %}&mes={{ mes }}{% endif %}{% if ano %}&ano={{ ano }}{% endif %}">Anterior</a></li>
            {% endif %}
            
            <li><span class="current">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>
            
            {% if page_obj.has_next %}
            <li><a href="?page={{ page_obj.next_page_number }}{% if mes %}&mes={{ mes }}{% endif %}{% if ano %}&ano={{ ano }}{% endif %}">Próxima</a></li>
            <li><a href="?page={{ page_obj.paginator.num_pages }}{% if mes %}&mes={{ mes }}{% endif %}{% if ano %}&ano={{ ano }}{% endif %}">Última &raquo;</a></li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
{% else %}
    <div class="alert alert-info text-center">
        <i class="fas fa-info-circle me-2"></i>
        {% block mensagem_vazio_dashboard %}Não há itens cadastrados para o mês/ano informado.{% endblock %}
    </div>
{% endif %}
{% endblock %}

<!-- Token CSRF para JavaScript -->
{% csrf_token %}

{% block extra_js %}
<script>
let itemIdAtual = null;
let dadosItemAtual = null;

// Função para garantir que o modal existe
function garantirModalExiste() {
    let modal = document.getElementById('modalEnvioMensagem');
    if (!modal) {
        // Criar modal dinamicamente
        modal = document.createElement('div');
        modal.id = 'modalEnvioMensagem';
        modal.style.cssText = 'display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);';
        modal.innerHTML = `
            <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px;">
                    <h5 style="margin: 0; font-weight: bold;">Enviar Mensagem/Email</h5>
                    <button type="button" class="btn-fechar-modal" style="background: none; border: none; font-size: 24px; font-weight: bold; color: #aaa; cursor: pointer; padding: 0; width: 30px; height: 30px; line-height: 24px;">&times;</button>
                </div>
                <div>
                    <p>Deseja enviar mensagem e/ou e-mail para o colaborador?</p>
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; border-top: 1px solid #dee2e6; padding-top: 15px;">
                        <button type="button" class="btn-nao-enviar btn btn-secondary" style="padding: 8px 16px; border: 1px solid #6c757d; background-color: #6c757d; color: white; border-radius: 4px; cursor: pointer;">Não</button>
                        <button type="button" class="btn-sim-enviar btn btn-primary" style="padding: 8px 16px; border: 1px solid #007bff; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer;">Sim</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Adicionar event listeners aos botões usando event delegation
        modal.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-fechar-modal') || e.target === modal) {
                fecharModalEnvio();
            } else if (e.target.classList.contains('btn-nao-enviar')) {
                salvarApontamentoSemEnvio();
            } else if (e.target.classList.contains('btn-sim-enviar')) {
                salvarApontamentoComEnvio();
            }
        });
    }
    return modal;
}

window.abrirModalEnvio = function(itemId) {
    console.log('abrirModalEnvio chamado com itemId:', itemId);
    itemIdAtual = itemId;
    const modal = garantirModalExiste();
    modal.style.display = 'block';
    console.log('Modal aberto');
}

function fecharModalEnvio() {
    const modal = document.getElementById('modalEnvioMensagem');
    if (modal) {
        modal.style.display = 'none';
    }
    itemIdAtual = null;
}

function salvarApontamentoSemEnvio() {
    // Salvar itemId antes de fechar o modal
    const itemId = itemIdAtual;
    fecharModalEnvio();
    enviarApontamento(itemId, false);
}

function salvarApontamentoComEnvio() {
    // Salvar itemId antes de fechar o modal
    const itemId = itemIdAtual;
    fecharModalEnvio();
    enviarApontamento(itemId, true);
}

function enviarApontamento(itemId, enviarMensagem) {
    if (!itemId) {
        alert('Erro: Item não identificado');
        return;
    }
    
    // Pegar valores dos selects do grid
    const grupoSelect = document.getElementById('grupo_' + itemId);
    const statusSelect = document.getElementById('status_' + itemId);
    
    if (!grupoSelect || !statusSelect) {
        alert('Erro: Elementos do formulário não encontrados');
        return;
    }
    
    const grupoId = grupoSelect.value;
    const status = statusSelect.value;
    
    // Validar se grupo foi selecionado
    if (!grupoId || grupoId === '') {
        alert('Por favor, selecione um grupo antes de enviar.');
        return;
    }
    
    // Validar se status é DEFINIDO (único que permite envio)
    if (status !== 'DEFINIDO') {
        alert('Apenas itens com status "Definido" podem ser enviados. Por favor, altere o status para "Definido" antes de enviar.');
        return;
    }
    
    const data = {
        grupo_id: grupoId || null,
        status: status,
        enviar_mensagem: enviarMensagem
    };
    
    fetch(`/app_igreja/admin-area/apontamentos-escala-missa/${itemId}/atribuir/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Apontamento atribuído com sucesso!');
            location.reload();
        } else {
            alert('Erro ao atribuir apontamento: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atribuir apontamento. Tente novamente.');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Função alternativa para obter CSRF token
function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token) {
        return token.value;
    }
    return getCookie('csrftoken');
}

// Event listener para fechar modal ao clicar fora já está no modal criado dinamicamente

// Função para entrar em modo de edição do grupo
function entrarModoEdicao(itemId) {
    const container = document.getElementById('container_grupo_' + itemId);
    const wrapper = document.getElementById('wrapper_grupo_' + itemId);
    const nomeGrupoSpan = document.getElementById('nome_grupo_' + itemId);
    
    // Ocultar nome do grupo
    if (nomeGrupoSpan) {
        nomeGrupoSpan.style.display = 'none';
    }
    
    if (wrapper) {
        wrapper.classList.add('editing');
        const select = document.getElementById('grupo_' + itemId);
        if (select) {
            select.focus();
        }
    }
}

// Função para salvar grupo ao clicar no check
function salvarGrupo(itemId) {
    const grupoSelect = document.getElementById('grupo_' + itemId);
    const statusSelect = document.getElementById('status_' + itemId);
    const wrapper = document.getElementById('wrapper_grupo_' + itemId);
    const container = document.getElementById('container_grupo_' + itemId);
    
    if (!grupoSelect || !statusSelect) {
        alert('Erro: Elementos não encontrados');
        return;
    }
    
    const grupoId = grupoSelect.value || null;
    const status = statusSelect.value;
    
    if (!grupoId || grupoId === '') {
        alert('Por favor, selecione um grupo antes de salvar.');
        return;
    }
    
    // Validar status
    if (!['EM_ABERTO', 'RESERVADO', 'DEFINIDO'].includes(status)) {
        console.error('Status inválido:', status);
        return;
    }
    
    const data = {
        grupo_id: grupoId,
        status: status,
        enviar_mensagem: false
    };
    
    // Mostrar indicador visual
    const originalBg = grupoSelect.style.backgroundColor;
    grupoSelect.style.backgroundColor = '#fff3cd';
    
    fetch(`/app_igreja/admin-area/apontamentos-escala-missa/${itemId}/atribuir/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            grupoSelect.style.backgroundColor = originalBg;
            
            // Obter nome do grupo selecionado
            const grupoNome = grupoSelect.options[grupoSelect.selectedIndex].text;
            
            // Sair do modo edição e mostrar nome do grupo
            wrapper.classList.remove('editing');
            
            // Atualizar ou criar nome do grupo
            let nomeGrupoSpan = document.getElementById('nome_grupo_' + itemId);
            if (!nomeGrupoSpan) {
                nomeGrupoSpan = document.createElement('span');
                nomeGrupoSpan.id = 'nome_grupo_' + itemId;
                container.insertBefore(nomeGrupoSpan, wrapper);
            }
            nomeGrupoSpan.textContent = grupoNome;
            nomeGrupoSpan.style.display = 'inline';
        } else {
            alert('Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
            grupoSelect.style.backgroundColor = '#f8d7da';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar. Tente novamente.');
        grupoSelect.style.backgroundColor = '#f8d7da';
    });
}

// Função para atualizar ícone de enviar baseado em colaborador, grupo e status
// (Função mantida para compatibilidade, mas não é mais usada já que o ícone sempre está habilitado)
function atualizarIconeEnviar(itemId) {
    // Não precisa fazer nada, o ícone de lápis sempre está habilitado
        return;
}

// Função para entrar em modo de edição do status
function entrarModoEdicaoStatus(itemId) {
    const container = document.getElementById('container_status_' + itemId);
    const wrapper = document.getElementById('wrapper_status_' + itemId);
    const nomeStatusSpan = document.getElementById('nome_status_' + itemId);
    
    // Ocultar nome do status
    if (nomeStatusSpan) {
        nomeStatusSpan.style.display = 'none';
    }
    
    if (wrapper) {
        wrapper.classList.add('editing');
        const select = document.getElementById('status_' + itemId);
        if (select) {
            select.focus();
        }
    }
}

// Função para salvar status ao clicar no check
function salvarStatus(itemId) {
    const grupoSelect = document.getElementById('grupo_' + itemId);
    const statusSelect = document.getElementById('status_' + itemId);
    const wrapper = document.getElementById('wrapper_status_' + itemId);
    const container = document.getElementById('container_status_' + itemId);
    
    if (!statusSelect) {
        alert('Erro: Elementos não encontrados');
        return;
    }
    
    const grupoId = grupoSelect ? (grupoSelect.value || null) : null;
    const status = statusSelect.value;
    
    // Validar status
    if (!['EM_ABERTO', 'RESERVADO', 'DEFINIDO'].includes(status)) {
        alert('Status inválido');
        return;
    }
    
    const data = {
        grupo_id: grupoId,
        status: status,
        enviar_mensagem: false
    };
    
    // Mostrar indicador visual
    const originalBg = statusSelect.style.backgroundColor;
    statusSelect.style.backgroundColor = '#fff3cd';
    
    fetch(`/app_igreja/admin-area/apontamentos-escala-missa/${itemId}/atribuir/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusSelect.style.backgroundColor = originalBg;
            
            // Obter nome do status selecionado
            const statusNome = statusSelect.options[statusSelect.selectedIndex].text;
            
            // Sair do modo edição e mostrar nome do status
            wrapper.classList.remove('editing');
            
            // Atualizar ou criar nome do status
            let nomeStatusSpan = document.getElementById('nome_status_' + itemId);
            if (!nomeStatusSpan) {
                nomeStatusSpan = document.createElement('span');
                nomeStatusSpan.id = 'nome_status_' + itemId;
                container.insertBefore(nomeStatusSpan, wrapper);
            }
            nomeStatusSpan.textContent = statusNome;
            nomeStatusSpan.style.display = 'inline';
        } else {
            alert('Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
            statusSelect.style.backgroundColor = '#f8d7da';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar. Tente novamente.');
        statusSelect.style.backgroundColor = '#f8d7da';
    });
}

// Preencher mês e ano atual se não estiverem preenchidos
document.addEventListener('DOMContentLoaded', function() {
    // Garantir que o modal existe ao carregar a página
    garantirModalExiste();
    
    const mesSelect = document.getElementById('mes');
    const anoInput = document.getElementById('ano');
    
    if (mesSelect && !mesSelect.value) {
        const mesAtual = new Date().getMonth() + 1;
        mesSelect.value = mesAtual;
    }
    
    if (anoInput && !anoInput.value) {
        const anoAtual = new Date().getFullYear();
        anoInput.value = anoAtual;
    }
    
    // Event listeners para ícones de check grupo (salvar grupo)
    document.querySelectorAll('.icone-check').forEach(function(icone) {
        icone.addEventListener('click', function(e) {
            e.stopPropagation();
            const itemId = this.getAttribute('data-item-id');
            if (itemId) {
                salvarGrupo(parseInt(itemId));
            }
        });
    });
    
    // Event listeners para ícones de check status (salvar status)
    document.querySelectorAll('.icone-check-status').forEach(function(icone) {
        icone.addEventListener('click', function(e) {
            e.stopPropagation();
            const itemId = this.getAttribute('data-item-id');
            if (itemId) {
                salvarStatus(parseInt(itemId));
            }
        });
    });
    
    // Event listener para ícone de lápis (editar) na coluna de ação
    document.querySelectorAll('.icone-enviar').forEach(function(icone) {
        icone.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            
            const itemId = this.getAttribute('data-item-id');
            
            if (!itemId) {
                console.error('ItemId não encontrado');
                return;
            }
            
            // Coletar dados do item
            dadosItemAtual = {
                itemId: itemId,
                colaboradorNome: this.getAttribute('data-colaborador-nome') || '',
                encargo: this.getAttribute('data-encargo') || '',
                data: this.getAttribute('data-data') || '',
                diaSemana: this.getAttribute('data-dia-semana') || '',
                horario: this.getAttribute('data-horario') || '',
                grupoAtual: this.getAttribute('data-grupo-atual') || '',
                statusAtual: this.getAttribute('data-status-atual') || 'EM_ABERTO'
            };
            
            // Abrir modal de atribuição
            abrirModalAtribuicao(dadosItemAtual);
        });
    });
});

// Função para criar/garantir que o modal de atribuição existe
function garantirModalAtribuicao() {
    let modal = document.getElementById('modalAtribuicao');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalAtribuicao';
        modal.style.cssText = 'display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);';
        document.body.appendChild(modal);
    }
    return modal;
}

// Função para abrir modal de atribuição
function abrirModalAtribuicao(dados) {
    itemIdAtual = dados.itemId;
    const modal = garantirModalAtribuicao();
    
    // Buscar grupos disponíveis
    const grupos = [];
    document.querySelectorAll('#grupo_' + dados.itemId + ' option').forEach(function(opt) {
        if (opt.value) {
            grupos.push({ id: opt.value, nome: opt.textContent });
        }
    });
    
    // Criar HTML do modal
    let gruposOptions = '<option value="">Selecione...</option>';
    grupos.forEach(function(grupo) {
        const selected = grupo.id == dados.grupoAtual ? 'selected' : '';
        gruposOptions += `<option value="${grupo.id}" ${selected}>${grupo.nome}</option>`;
    });
    
    const statusOptions = `
        <option value="EM_ABERTO" ${dados.statusAtual == 'EM_ABERTO' ? 'selected' : ''}>Em Aberto</option>
        <option value="RESERVADO" ${dados.statusAtual == 'RESERVADO' ? 'selected' : ''}>Reservado</option>
        <option value="DEFINIDO" ${dados.statusAtual == 'DEFINIDO' ? 'selected' : ''}>Definido</option>
    `;
    
    modal.innerHTML = `
        <div style="background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="margin-bottom: 25px;">
                <h4 style="margin: 0 0 20px 0; font-weight: bold; color: #333;">Atribuir Apontamento</h4>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Grupo:</label>
                <select id="modal-grupo-select" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    ${gruposOptions}
                </select>
            </div>
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Status:</label>
                <select id="modal-status-select" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    ${statusOptions}
                </select>
            </div>
            <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6;">
                <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #555;">Situação:</label>
                <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="acao_situacao" value="bloquear" id="radio-bloquear" style="margin-right: 8px; cursor: pointer;">
                        <span>Bloquear</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="acao_situacao" value="desbloquear" id="radio-desbloquear" style="margin-right: 8px; cursor: pointer;">
                        <span>Desbloquear</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="acao_situacao" value="janelas" id="radio-janelas" style="margin-right: 8px; cursor: pointer;">
                        <span>Janelas</span>
                    </label>
                </div>
                <div id="campo-janelas" class="campo-periodo" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #666; font-size: 13px;">Tipo de Janela:</label>
                    <select id="select-janelas" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="">Selecione...</option>
                        <option value="1">Todas Leituras</option>
                        <option value="2">Diferente da escolha Anterior</option>
                        <option value="3">Diferente das últimas duas escolhidas</option>
                    </select>
                </div>
                <div id="campo-periodo" class="campo-periodo">
                    <div class="campos-data">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #666; font-size: 13px;">Dia Inicial:</label>
                            <input type="number" id="dia-inicial" min="1" max="31" placeholder="Ex: 1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #666; font-size: 13px;">Dia Final:</label>
                            <input type="number" id="dia-final" min="1" max="31" placeholder="Ex: 15" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        </div>
                    </div>
                </div>
            </div>
            <div id="modal-botoes-atribuir" style="display: flex; justify-content: space-between; gap: 10px; margin-bottom: 15px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                <button type="button" class="btn-modal-cancelar" style="flex: 1; padding: 12px; border: 1px solid #6c757d; background-color: #6c757d; color: white; border-radius: 4px; cursor: pointer; font-weight: 600;">Cancelar</button>
                <button type="button" class="btn-modal-atribuir" style="flex: 1; padding: 12px; border: 1px solid #007bff; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; font-weight: 600;">Atribuir</button>
            </div>
            <div id="modal-botoes-enviar" style="display: none; justify-content: space-between; gap: 10px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                <button type="button" class="btn-modal-voltar" style="flex: 1; padding: 12px; border: 1px solid #6c757d; background-color: #6c757d; color: white; border-radius: 4px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
                <button type="button" class="btn-modal-enviar-whatsapp" style="flex: 1; padding: 12px; border: 1px solid #25D366; background-color: #25D366; color: white; border-radius: 4px; cursor: pointer; font-weight: 600;">
                    <i class="fab fa-whatsapp"></i> Enviar WhatsApp
                </button>
            </div>
        </div>
    `;
    
    modal.style.display = 'block';
    
    // Event listeners
    modal.querySelector('.btn-modal-cancelar').addEventListener('click', fecharModalAtribuicao);
    modal.querySelector('.btn-modal-atribuir').addEventListener('click', atribuirApontamento);
    modal.querySelector('.btn-modal-voltar').addEventListener('click', fecharModalAtribuicao);
    modal.querySelector('.btn-modal-enviar-whatsapp').addEventListener('click', enviarWhatsAppApontamento);
    
    // Event listeners para radio buttons de situação
    const radioBloquear = document.getElementById('radio-bloquear');
    const radioDesbloquear = document.getElementById('radio-desbloquear');
    const radioJanelas = document.getElementById('radio-janelas');
    const campoPeriodo = document.getElementById('campo-periodo');
    const campoJanelas = document.getElementById('campo-janelas');
    
    function toggleCampos() {
        if (radioBloquear.checked || radioDesbloquear.checked) {
            campoPeriodo.classList.add('visivel');
            campoJanelas.classList.remove('visivel');
        } else if (radioJanelas.checked) {
            campoPeriodo.classList.add('visivel');
            campoJanelas.classList.add('visivel');
        } else {
            campoPeriodo.classList.remove('visivel');
            campoJanelas.classList.remove('visivel');
        }
    }
    
    radioBloquear.addEventListener('change', toggleCampos);
    radioDesbloquear.addEventListener('change', toggleCampos);
    radioJanelas.addEventListener('change', toggleCampos);
    
    // Fechar ao clicar fora
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            fecharModalAtribuicao();
        }
    });
}

// Função para fechar modal
function fecharModalAtribuicao() {
    const modal = document.getElementById('modalAtribuicao');
    if (modal) {
        modal.style.display = 'none';
    }
    itemIdAtual = null;
    dadosItemAtual = null;
}

// Função para atribuir apontamento
function atribuirApontamento() {
    if (!dadosItemAtual) {
        alert('Erro: Dados do item não encontrados');
                return;
            }
            
    const grupoSelect = document.getElementById('modal-grupo-select');
    const statusSelect = document.getElementById('modal-status-select');
            
            if (!grupoSelect || !statusSelect) {
                alert('Erro: Elementos do formulário não encontrados');
                return;
            }
            
    const grupoId = grupoSelect.value;
            const status = statusSelect.value;
            
            if (!grupoId || grupoId === '') {
        alert('Por favor, selecione um grupo antes de atribuir.');
                return;
            }
            
    // Obter valores de situação (bloquear/desbloquear/janelas)
    const radioBloquear = document.getElementById('radio-bloquear');
    const radioDesbloquear = document.getElementById('radio-desbloquear');
    const radioJanelas = document.getElementById('radio-janelas');
    const selectJanelas = document.getElementById('select-janelas');
    const diaInicial = document.getElementById('dia-inicial').value;
    const diaFinal = document.getElementById('dia-final').value;
    
    let acaoSituacao = null;
    let janelaValor = null;
    
    if (radioBloquear.checked) {
        acaoSituacao = 'bloquear';
    } else if (radioDesbloquear.checked) {
        acaoSituacao = 'desbloquear';
    } else if (radioJanelas && radioJanelas.checked) {
        acaoSituacao = 'janelas';
        janelaValor = selectJanelas ? selectJanelas.value : null;
        
        // Validar se janela foi selecionada
        if (!janelaValor || janelaValor === '') {
            alert('Por favor, selecione um tipo de janela.');
            return;
        }
    }
    
    // Validar período se uma ação foi selecionada
    if (acaoSituacao) {
        if (!diaInicial || !diaFinal) {
            const acaoTexto = acaoSituacao === 'bloquear' ? 'bloquear' : 
                            acaoSituacao === 'desbloquear' ? 'desbloquear' : 
                            'aplicar janela';
            alert('Por favor, informe o dia inicial e dia final para ' + acaoTexto + ' o período.');
            return;
        }
            
        const diaInicialInt = parseInt(diaInicial);
        const diaFinalInt = parseInt(diaFinal);
        
        if (isNaN(diaInicialInt) || isNaN(diaFinalInt)) {
            alert('Dias devem ser números válidos.');
            return;
        }
        
        if (diaInicialInt < 1 || diaInicialInt > 31 || diaFinalInt < 1 || diaFinalInt > 31) {
            alert('Dias devem estar entre 1 e 31.');
            return;
        }
        
        if (diaInicialInt > diaFinalInt) {
            alert('Dia inicial deve ser menor ou igual ao dia final.');
            return;
        }
    }
    
    const data = {
        grupo_id: grupoId,
        status: status,
        enviar_mensagem: false,
        acao_situacao: acaoSituacao,
        dia_inicial: diaInicial || null,
        dia_final: diaFinal || null,
        janela: janelaValor ? parseInt(janelaValor) : null
    };
    
    // Desabilitar botões durante o processamento
    const btnAtribuir = document.querySelector('.btn-modal-atribuir');
    const btnCancelar = document.querySelector('.btn-modal-cancelar');
    if (btnAtribuir && !lockFormButtons(btnAtribuir)) return;
    if (btnCancelar) btnCancelar.disabled = true;
    
    fetch(`/app_igreja/admin-area/apontamentos-escala-missa/${dadosItemAtual.itemId}/atribuir/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Obter nome do grupo selecionado
            const grupoNome = grupoSelect.options[grupoSelect.selectedIndex].text;
            
            // Buscar item atual na tabela para obter data e horário
            const iconeLapis = document.querySelector(`.icone-enviar[data-item-id="${dadosItemAtual.itemId}"]`);
            let dataItem = null;
            let horarioItem = null;
            
            if (iconeLapis) {
                const itemRow = iconeLapis.closest('tr');
                if (itemRow) {
                    const dataCell = itemRow.querySelector('td[data-data-item]');
                    const horarioCell = itemRow.querySelector('td[data-horario-item]');
                    if (dataCell) dataItem = dataCell.getAttribute('data-data-item');
                    if (horarioCell) horarioItem = horarioCell.getAttribute('data-horario-item');
                }
            }
            
            // Atualizar o item atual no grid
            atualizarGrupoNoGrid(dadosItemAtual.itemId, grupoId, grupoNome);
            
            // Se tiver data e horário, atualizar todos os itens do mesmo horário
            if (dataItem && horarioItem) {
                atualizarGruposMesmoHorario(dataItem, horarioItem, grupoId, grupoNome, dadosItemAtual.itemId);
            }
            
            // Se houve bloqueio/desbloqueio, atualizar visualmente os itens do período
            const radioBloquear = document.getElementById('radio-bloquear');
            const radioDesbloquear = document.getElementById('radio-desbloquear');
            const diaInicial = document.getElementById('dia-inicial').value;
            const diaFinal = document.getElementById('dia-final').value;
            
            if ((radioBloquear && radioBloquear.checked) || (radioDesbloquear && radioDesbloquear.checked)) {
                if (diaInicial && diaFinal) {
                    const desbloqueado = radioDesbloquear && radioDesbloquear.checked;
                    atualizarVisualSituacaoPeriodo(diaInicial, diaFinal, desbloqueado);
                }
            }
            
            // Ocultar botões de atribuir e mostrar botões de enviar
            document.getElementById('modal-botoes-atribuir').style.display = 'none';
            document.getElementById('modal-botoes-enviar').style.display = 'flex';
            
            // Desabilitar selects
            grupoSelect.disabled = true;
            statusSelect.disabled = true;
            
            // Atualizar dados
            dadosItemAtual.grupoAtual = grupoId;
            dadosItemAtual.statusAtual = status;
        } else {
            alert('Erro ao atribuir: ' + (data.error || 'Erro desconhecido'));
            btnAtribuir.disabled = false;
            btnCancelar.disabled = false;
            btnAtribuir.textContent = 'Atribuir';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atribuir. Tente novamente.');
        btnAtribuir.disabled = false;
        btnCancelar.disabled = false;
        btnAtribuir.textContent = 'Atribuir';
    });
}

// Função para atualizar grupo no grid
function atualizarGrupoNoGrid(itemId, grupoId, grupoNome) {
    const container = document.getElementById('container_grupo_' + itemId);
    const wrapper = document.getElementById('wrapper_grupo_' + itemId);
    
    if (!container) return;
    
    // Atualizar ou criar nome do grupo
    let nomeGrupoSpan = document.getElementById('nome_grupo_' + itemId);
    if (!nomeGrupoSpan) {
        nomeGrupoSpan = document.createElement('span');
        nomeGrupoSpan.id = 'nome_grupo_' + itemId;
        container.insertBefore(nomeGrupoSpan, wrapper);
    }
    nomeGrupoSpan.textContent = grupoNome;
    nomeGrupoSpan.style.display = 'inline';
    
    // Atualizar select oculto também
    const grupoSelect = document.getElementById('grupo_' + itemId);
    if (grupoSelect) {
        grupoSelect.value = grupoId;
    }
    
    // Atualizar atributo data-grupo-atual no ícone de lápis
    const iconeLapis = document.querySelector(`.icone-enviar[data-item-id="${itemId}"]`);
    if (iconeLapis) {
        iconeLapis.setAttribute('data-grupo-atual', grupoId);
    }
}

// Função para atualizar grupos de todos os itens do mesmo horário
function atualizarGruposMesmoHorario(dataItem, horarioItem, grupoId, grupoNome, itemIdExcluir) {
    // Buscar todas as linhas da tabela com mesma data e horário
    const todasLinhas = document.querySelectorAll('tbody tr');
    
    todasLinhas.forEach(function(linha) {
        const dataCell = linha.querySelector('td[data-data-item]');
        const horarioCell = linha.querySelector('td[data-horario-item]');
        
        if (!dataCell || !horarioCell) return;
        
        const dataLinha = dataCell.getAttribute('data-data-item');
        const horarioLinha = horarioCell.getAttribute('data-horario-item');
        
        // Verificar se é o mesmo dia e horário
        if (dataLinha === dataItem && horarioLinha === horarioItem) {
            // Buscar itemId desta linha
            const iconeLapis = linha.querySelector('.icone-enviar');
            if (iconeLapis) {
                const itemIdLinha = iconeLapis.getAttribute('data-item-id');
                
                // Não atualizar o item que foi editado (já foi atualizado)
                if (itemIdLinha && itemIdLinha !== itemIdExcluir) {
                    atualizarGrupoNoGrid(itemIdLinha, grupoId, grupoNome);
                }
            }
        }
    });
}

// Função para atualizar visualmente a situação dos itens do período
function atualizarVisualSituacaoPeriodo(diaInicial, diaFinal, desbloqueado) {
    const todasLinhas = document.querySelectorAll('tbody tr');
    
    todasLinhas.forEach(function(linha) {
        const dataCell = linha.querySelector('td[data-data-item]');
        if (!dataCell) return;
        
        // Extrair dia da data (formato YYYY-MM-DD)
        const dataCompleta = dataCell.getAttribute('data-data-item');
        const partesData = dataCompleta.split('-');
        if (partesData.length !== 3) return;
        
        const diaItem = parseInt(partesData[2]);
        const diaInicialInt = parseInt(diaInicial);
        const diaFinalInt = parseInt(diaFinal);
        
        // Verificar se o item está no período
        if (diaItem >= diaInicialInt && diaItem <= diaFinalInt) {
            if (desbloqueado) {
                // Remover classe de bloqueado
                linha.classList.remove('item-bloqueado');
                linha.setAttribute('data-situacao', 'true');
            } else {
                // Adicionar classe de bloqueado
                linha.classList.add('item-bloqueado');
                linha.setAttribute('data-situacao', 'false');
            }
        }
    });
}

// Função para enviar WhatsApp
function enviarWhatsAppApontamento() {
    if (!dadosItemAtual) {
        alert('Erro: Dados do item não encontrados');
        return;
    }
    
    if (!dadosItemAtual.colaboradorNome || dadosItemAtual.colaboradorNome === '-') {
        alert('Erro: Colaborador não atribuído a este item.');
        return;
    }
    
    const btnEnviar = document.querySelector('.btn-modal-enviar-whatsapp');
    const btnVoltar = document.querySelector('.btn-modal-voltar');
    if (btnEnviar && !lockFormButtons(btnEnviar)) return;
    if (btnVoltar) btnVoltar.disabled = true;
    
    const data = {
        grupo_id: dadosItemAtual.grupoAtual,
        status: dadosItemAtual.statusAtual,
        enviar_mensagem: true
    };
    
    fetch(`/app_igreja/admin-area/apontamentos-escala-missa/${dadosItemAtual.itemId}/atribuir/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('WhatsApp enviado com sucesso!');
            fecharModalAtribuicao();
            location.reload();
        } else {
            alert('Erro ao enviar WhatsApp: ' + (data.error || 'Erro desconhecido'));
            btnEnviar.disabled = false;
            btnVoltar.disabled = false;
            btnEnviar.innerHTML = '<i class="fab fa-whatsapp"></i> Enviar WhatsApp';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao enviar WhatsApp. Tente novamente.');
        btnEnviar.disabled = false;
        btnVoltar.disabled = false;
        btnEnviar.innerHTML = '<i class="fab fa-whatsapp"></i> Enviar WhatsApp';
    });
}
</script>
{% endblock %}

{% block botao_flutuante_dashboard %}
<!-- Botão flutuante oculto para este módulo -->
{% endblock %}

