{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
/* CSS específico do módulo WhatsApp - ocultar estatísticas */
.panel-container_estatistica {
    display: none !important;
}
</style>
{% endblock %}

{% block title %}Mensagens WhatsApp{% endblock %}

<!-- === BLOCO DASHBOARD === -->
{% block icone_dashboard %}fab fa-whatsapp{% endblock %}
{% block nome_modulo_dashboard %}WhatsApp{% endblock %}
{% block url_retornar_dashboard %}{% url 'app_igreja:admin_area' %}{% endblock %}
{% block url_criar_novo_dashboard %}{% url 'app_igreja:whatsapp_enviar_mensagem' %}{% endblock %}
{% block nome_modulo_lista_dashboard %}Mensagens WhatsApp{% endblock %}

<!-- === BLOCO ESTATÍSTICAS DASHBOARD === -->
{% block estatisticas_dashboard %}
<!-- PAINEL DE ESTATÍSTICAS OCULTO PARA WHATSAPP -->
{% endblock %}

<!-- === BLOCO BUSCA DASHBOARD === -->
{% block busca_dashboard %}
{% if acao != 'incluir' and acao != 'editar' %}
<form method="get" class="busca-campos">
    <div class="campo-busca">
        <label for="filtro_status">Status</label>
        <select id="filtro_status" name="status">
            <option value="">Todos</option>
            <option value="ENVIADA" {% if status_filter == 'ENVIADA' %}selected{% endif %}>Enviadas</option>
            <option value="ERRO" {% if status_filter == 'ERRO' %}selected{% endif %}>Erro</option>
        </select>
    </div>
    <div class="campo-busca">
        <label for="filtro_tipo">Tipo</label>
        <select id="filtro_tipo" name="tipo_destinatario">
            <option value="">Todos</option>
            <option value="DIZIMISTAS" {% if tipo_filter == 'DIZIMISTAS' %}selected{% endif %}>Dizimista</option>
            <option value="COLABORADORES" {% if tipo_filter == 'COLABORADORES' %}selected{% endif %}>Colaboradores</option>
        </select>
    </div>
    <div class="campo-busca">
        <label for="data_inicio">Data Início</label>
        <input type="date" id="data_inicio" name="data_inicio" value="{{ data_inicio }}" placeholder="dd/mm/aaaa">
                </div>
    <div class="campo-busca">
        <label for="data_fim">Data Fim</label>
        <input type="date" id="data_fim" name="data_fim" value="{{ data_fim }}" placeholder="dd/mm/aaaa">
                    </div>
    <button type="submit" class="cont_busca_btnbusca"><i class="fas fa-search"></i></button>
</form>
{% endif %}
{% endblock %}

<!-- === BLOCO COLUNAS CABEÇALHO DASHBOARD === -->
{% block colunas_cabecalho_dashboard %}
{% if acao != 'incluir' and acao != 'editar' %}
<th width="20%">Data/Hora</th>
<th width="25%">Destinatário</th>
<th width="20%">Tipo</th>
<th width="35%">Estatísticas</th>
{% endif %}
{% endblock %}

<!-- === BLOCO LINHAS TABELA DASHBOARD === -->
{% block linhas_tabela_dashboard %}
{% if acao != 'incluir' and acao != 'editar' %}
{% if busca_realizada %}
    {% for mensagem in page_obj %}
    <tr>
        {% block linha_completa_dashboard %}
        <td>
            <i class="fas fa-ellipsis-v" onclick="selecionarRegistroDashboard({{ mensagem.WHA_id }})" style="cursor: pointer; padding: 8px; border-radius: 4px; transition: all 0.3s ease; font-size: 16px;" onmouseover="this.style.backgroundColor='#e9ecef'" onmouseout="this.style.backgroundColor='transparent'"></i>
            <!-- Botões de ação -->
            <div class="botoes-acao" id="acoes_{{ mensagem.WHA_id }}" style="display: none;">
                <div class="d-flex gap-2 justify-content-start align-items-center">
                    <a href="{% url 'app_igreja:whatsapp_detail' mensagem.WHA_id %}" class="btn btn-info btn-sm d-flex align-items-center">
                        <i class="fas fa-eye me-1"></i>Consultar
                    </a>
                    {% if mensagem.WHA_status == 'ERRO' %}
                    <a href="{% url 'app_igreja:whatsapp_enviar_mensagem' %}?editar={{ mensagem.WHA_id }}" class="btn btn-warning btn-sm d-flex align-items-center">
                        <i class="fas fa-edit me-1"></i>Editar
                    </a>
                    <a href="{% url 'app_igreja:whatsapp_excluir' mensagem.WHA_id %}" class="btn btn-danger btn-sm d-flex align-items-center">
                        <i class="fas fa-trash me-1"></i>Excluir
                    </a>
                    {% endif %}
                </div>
            </div>
        </td>
        <td>{{ mensagem.WHA_data_criacao|date:"d/m/Y H:i" }}</td>
        <td>
            <span class="badge bg-primary">{{ mensagem.get_WHA_destinatario_tipo_display }}</span>
        </td>
        <td>
            <span class="badge bg-info">{{ mensagem.get_WHA_tipo_midia_display }}</span>
        </td>
        <td><strong>Total:</strong> {{ mensagem.WHA_total_enviadas }} | <strong>Enviada:</strong> {{ mensagem.WHA_sucessos|default:0 }} | <strong>erro:</strong> {{ mensagem.WHA_erros|default:0 }}</td>
        {% endblock %}
    </tr>
    {% empty %}
    <tr>
        <td colspan="5" class="text-center text-muted">
            <i class="fab fa-whatsapp fa-2x mb-2"></i>
            <br>
            Nenhuma mensagem encontrada para os filtros informados.
        </td>
    </tr>
    {% endfor %}
{% else %}
    <tr>
        <td colspan="5" class="text-center text-muted">
            <i class="fas fa-search fa-2x mb-2"></i>
            <br>
            Preencha os filtros acima e clique em <strong>Buscar</strong> para listar as mensagens WhatsApp.
        </td>
    </tr>
{% endif %}
{% endif %}
{% endblock %}

<!-- === BLOCO MENSAGEM VAZIO DASHBOARD === -->
{% block mensagem_vazio_dashboard %}Não há mensagens WhatsApp cadastradas ou que correspondam aos filtros aplicados.{% endblock %}

{% block conteudo_detalhe %}
{% if acao == 'incluir' or acao == 'editar' %}
<!-- FORMULÁRIO DE ENVIO DE MENSAGENS -->
<form id="detail-form" method="post" enctype="multipart/form-data" action="{% url 'app_igreja:whatsapp_enviar_mensagem' %}{% if acao == 'editar' and mensagem %}?editar={{ mensagem.WHA_id }}{% endif %}" onsubmit="return lockFormButtons(this)">
                        {% csrf_token %}
                        
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            <h6>Erro ao preparar mensagem:</h6>
            {% for error in form.non_field_errors %}
                <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}

    <!-- ABAS: Dizimista | Colaborador -->
    <div class="row mb-3">
        <div class="col-12">
            <ul class="nav nav-tabs" id="destinatarioTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dizimista-tab" data-bs-toggle="tab" data-bs-target="#dizimista-pane" type="button" role="tab">
                        <i class="fas fa-users me-1"></i>Dizimista
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="colaborador-tab" data-bs-toggle="tab" data-bs-target="#colaborador-pane" type="button" role="tab">
                        <i class="fas fa-user-tie me-1"></i>Colaborador
                    </button>
                </li>
            </ul>
        </div>
                        </div>

    <!-- CONTEÚDO DAS ABAS -->
    <div class="tab-content" id="destinatarioTabsContent">
        <!-- ABA DIZIMISTA -->
        <div class="tab-pane fade show active" id="dizimista-pane" role="tabpanel">
            <input type="hidden" name="tipo_destinatario" value="DIZIMISTAS" id="tipo_destinatario_dizimista">
            
            <div class="card border-primary mb-3">
                                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-users"></i> Configuração para Dizimistas</h6>
                                </div>
                                <div class="card-body">
                    <!-- Dizimista Específico -->
                                    <div class="mb-3">
                                        <label for="{{ form.dizimista_especifico.id_for_label }}" class="form-label">
                            <strong>Dizimista Específico:</strong>
                                        </label>
                                        {{ form.dizimista_especifico }}
                                        {% if form.dizimista_especifico.errors %}
                            <div class="text-danger small">{{ form.dizimista_especifico.errors }}</div>
                                        {% endif %}
                                        <div class="form-text">Selecione um dizimista específico ou deixe em branco para usar filtros</div>
                                    </div>
                                    
                    <!-- Campos de Filtro (ocultos quando dizimista específico é selecionado) -->
                    <div id="filtros-dizimista">
                                    <div class="row">
                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.filtrar_dizimista.id_for_label }}" class="form-label">
                                                    <strong>{{ form.filtrar_dizimista.label }}</strong>
                                                </label>
                                                {{ form.filtrar_dizimista }}
                                                {% if form.filtrar_dizimista.errors %}
                                    <div class="text-danger small">{{ form.filtrar_dizimista.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.data_nascimento_dizimista_inicio.id_for_label }}" class="form-label">
                                                    <strong>{{ form.data_nascimento_dizimista_inicio.label }}</strong>
                                                </label>
                                                {{ form.data_nascimento_dizimista_inicio }}
                                                {% if form.data_nascimento_dizimista_inicio.errors %}
                                    <div class="text-danger small">{{ form.data_nascimento_dizimista_inicio.errors }}</div>
                                                {% endif %}
                                            </div>
                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.data_nascimento_dizimista_fim.id_for_label }}" class="form-label">
                                                    <strong>{{ form.data_nascimento_dizimista_fim.label }}</strong>
                                                </label>
                                                {{ form.data_nascimento_dizimista_fim }}
                                                {% if form.data_nascimento_dizimista_fim.errors %}
                                    <div class="text-danger small">{{ form.data_nascimento_dizimista_fim.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

        <!-- ABA COLABORADOR -->
        <div class="tab-pane fade" id="colaborador-pane" role="tabpanel">
            <input type="hidden" name="tipo_destinatario" value="COLABORADORES" id="tipo_destinatario_colaborador">
            
            <div class="card border-info mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-user-tie"></i> Configuração para Colaboradores</h6>
                                </div>
                                <div class="card-body">
                    <!-- Colaborador Específico -->
                                    <div class="mb-3">
                                        <label for="{{ form.colaborador_especifico.id_for_label }}" class="form-label">
                            <strong>Colaborador Específico:</strong>
                                        </label>
                                        {{ form.colaborador_especifico }}
                                        {% if form.colaborador_especifico.errors %}
                            <div class="text-danger small">{{ form.colaborador_especifico.errors }}</div>
                                        {% endif %}
                                        <div class="form-text">Selecione um colaborador específico ou deixe em branco para usar filtros</div>
                                    </div>
                                    
                    <!-- Campos de Filtro (ocultos quando colaborador específico é selecionado) -->
                    <div id="filtros-colaborador">
                                    <div class="row">
                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.filtrar_colaborador.id_for_label }}" class="form-label">
                                                    <strong>{{ form.filtrar_colaborador.label }}</strong>
                                                </label>
                                                {{ form.filtrar_colaborador }}
                                                {% if form.filtrar_colaborador.errors %}
                                    <div class="text-danger small">{{ form.filtrar_colaborador.errors }}</div>
                                                {% endif %}
                                            </div>
                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.grupo_colaborador.id_for_label }}" class="form-label">
                                                    <strong>{{ form.grupo_colaborador.label }}</strong>
                                                </label>
                                                {{ form.grupo_colaborador }}
                                                {% if form.grupo_colaborador.errors %}
                                    <div class="text-danger small">{{ form.grupo_colaborador.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.data_nascimento_colaborador_inicio.id_for_label }}" class="form-label">
                                                    <strong>{{ form.data_nascimento_colaborador_inicio.label }}</strong>
                                                </label>
                                                {{ form.data_nascimento_colaborador_inicio }}
                                                {% if form.data_nascimento_colaborador_inicio.errors %}
                                    <div class="text-danger small">{{ form.data_nascimento_colaborador_inicio.errors }}</div>
                                                {% endif %}
                                            </div>
                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.data_nascimento_colaborador_fim.id_for_label }}" class="form-label">
                                                    <strong>{{ form.data_nascimento_colaborador_fim.label }}</strong>
                                                </label>
                                                {{ form.data_nascimento_colaborador_fim }}
                                                {% if form.data_nascimento_colaborador_fim.errors %}
                                    <div class="text-danger small">{{ form.data_nascimento_colaborador_fim.errors }}</div>
                                                {% endif %}
                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

    <!-- TIPO DE MÍDIA -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                            <label for="{{ form.tipo_midia.id_for_label }}" class="form-label">
                                <strong>{{ form.tipo_midia.label }}</strong>
                            </label>
                            {{ form.tipo_midia }}
                            {% if form.tipo_midia.errors %}
                        <div class="text-danger small">{{ form.tipo_midia.errors }}</div>
                            {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- FORMULÁRIO DE MÍDIA (ESTILO CORTINA) -->
    <div id="formulario-midia" style="display: none;">
        <!-- Campos de Imagem -->
        <div id="campos-imagem" style="display: none;">
            <div class="card border-info mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-image"></i> Configuração de Imagem</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ form.url_imagem.id_for_label }}" class="form-label"><strong>{{ form.url_imagem.label }}</strong></label>
                        {{ form.url_imagem }}
                        {% if form.url_imagem.errors %}<div class="text-danger small">{{ form.url_imagem.errors }}</div>{% endif %}
                        <div class="form-text">{{ form.url_imagem.help_text }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.arquivo_imagem.id_for_label }}" class="form-label"><strong>{{ form.arquivo_imagem.label }}</strong></label>
                        {{ form.arquivo_imagem }}
                        {% if form.arquivo_imagem.errors %}<div class="text-danger small">{{ form.arquivo_imagem.errors }}</div>{% endif %}
                        <div class="form-text">{{ form.arquivo_imagem.help_text }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.legenda_imagem.id_for_label }}" class="form-label"><strong>{{ form.legenda_imagem.label }}</strong></label>
                        {{ form.legenda_imagem }}
                        {% if form.legenda_imagem.errors %}<div class="text-danger small">{{ form.legenda_imagem.errors }}</div>{% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Campos de Áudio -->
        <div id="campos-audio" style="display: none;">
            <div class="card border-warning mb-3">
                <div class="card-header bg-warning text-white">
                    <h6 class="mb-0"><i class="fas fa-volume-up"></i> Configuração de Áudio</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ form.url_audio.id_for_label }}" class="form-label"><strong>{{ form.url_audio.label }}</strong></label>
                        {{ form.url_audio }}
                        {% if form.url_audio.errors %}<div class="text-danger small">{{ form.url_audio.errors }}</div>{% endif %}
                        <div class="form-text">{{ form.url_audio.help_text }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.arquivo_audio.id_for_label }}" class="form-label"><strong>{{ form.arquivo_audio.label }}</strong></label>
                        {{ form.arquivo_audio }}
                        {% if form.arquivo_audio.errors %}<div class="text-danger small">{{ form.arquivo_audio.errors }}</div>{% endif %}
                        <div class="form-text">{{ form.arquivo_audio.help_text }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campos de Vídeo -->
        <div id="campos-video" style="display: none;">
            <div class="card border-danger mb-3">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="fas fa-video"></i> Configuração de Vídeo</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ form.url_video.id_for_label }}" class="form-label"><strong>{{ form.url_video.label }}</strong></label>
                        {{ form.url_video }}
                        {% if form.url_video.errors %}<div class="text-danger small">{{ form.url_video.errors }}</div>{% endif %}
                        <div class="form-text">{{ form.url_video.help_text }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.arquivo_video.id_for_label }}" class="form-label"><strong>{{ form.arquivo_video.label }}</strong></label>
                        {{ form.arquivo_video }}
                        {% if form.arquivo_video.errors %}<div class="text-danger small">{{ form.arquivo_video.errors }}</div>{% endif %}
                        <div class="form-text">{{ form.arquivo_video.help_text }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.legenda_video.id_for_label }}" class="form-label"><strong>{{ form.legenda_video.label }}</strong></label>
                        {{ form.legenda_video }}
                        {% if form.legenda_video.errors %}<div class="text-danger small">{{ form.legenda_video.errors }}</div>{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MENSAGEM -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <label for="{{ form.texto.id_for_label }}" class="form-label">
                        <strong>{{ form.texto.label }}</strong>
                    </label>
                    {{ form.texto }}
                    {% if form.texto.errors %}
                        <div class="text-danger small">{{ form.texto.errors }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</form>
{% elif acao == 'consultar' and mensagem %}
<!-- DETALHES DA MENSAGEM -->
<div class="card">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fab fa-whatsapp me-2"></i>Detalhes da Mensagem WhatsApp</h5>
    </div>
    <div class="card-body">
    <div class="row">
            <div class="col-md-6 mb-3">
                <strong>Data/Hora:</strong><br>
                {{ mensagem.WHA_data_criacao|date:"d/m/Y H:i:s" }}
            </div>
            <div class="col-md-6 mb-3">
                <strong>Status:</strong><br>
                {% if mensagem.WHA_status == 'ENVIADA' %}
                    <span class="badge bg-success">{{ mensagem.get_WHA_status_display }}</span>
                {% elif mensagem.WHA_status == 'ERRO' %}
                    <span class="badge bg-danger">{{ mensagem.get_WHA_status_display }}</span>
                {% else %}
                    <span class="badge bg-warning">{{ mensagem.get_WHA_status_display }}</span>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <strong>Destinatário:</strong><br>
                <span class="badge bg-primary">{{ mensagem.get_WHA_destinatario_tipo_display }}</span>
            </div>
            <div class="col-md-6 mb-3">
                <strong>Tipo de Mídia:</strong><br>
                <span class="badge bg-info">{{ mensagem.get_WHA_tipo_midia_display }}</span>
            </div>
            <div class="col-12 mb-3">
                <strong>Mensagem:</strong><br>
                <div class="border p-3 rounded bg-light">
                    {{ mensagem.WHA_texto|default:"-"|linebreaks }}
                </div>
            </div>
            {% if mensagem.WHA_url_imagem %}
            <div class="col-12 mb-3">
                <strong>URL da Imagem:</strong><br>
                <a href="{{ mensagem.WHA_url_imagem }}" target="_blank">{{ mensagem.WHA_url_imagem }}</a>
            </div>
            {% endif %}
            {% if mensagem.WHA_legenda_imagem %}
            <div class="col-12 mb-3">
                <strong>Legenda da Imagem:</strong><br>
                {{ mensagem.WHA_legenda_imagem }}
                        </div>
                    {% endif %}
            <div class="col-md-4 mb-3">
                <strong>Total Enviadas:</strong><br>
                <span class="badge bg-secondary">{{ mensagem.WHA_total_enviadas }}</span>
            </div>
            <div class="col-md-4 mb-3">
                <strong>Sucessos:</strong><br>
                <span class="badge bg-success">{{ mensagem.WHA_sucessos|default:0 }}</span>
            </div>
            <div class="col-md-4 mb-3">
                <strong>Erros:</strong><br>
                <span class="badge bg-danger">{{ mensagem.WHA_erros|default:0 }}</span>
            </div>
            {% if mensagem.WHA_erro %}
            <div class="col-12 mb-3">
                <strong>Erro:</strong><br>
                <div class="alert alert-danger">
                    {{ mensagem.WHA_erro|linebreaks }}
                </div>
            </div>
            {% endif %}
            {% if mensagem.WHA_usuario %}
            <div class="col-12 mb-3">
                <strong>Enviado por:</strong><br>
                {{ mensagem.WHA_usuario.get_full_name|default:mensagem.WHA_usuario.username }}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% elif acao == 'excluir' and mensagem %}
<!-- CONFIRMAÇÃO DE EXCLUSÃO -->
<div class="card">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão</h5>
    </div>
    <div class="card-body">
        <p>Tem certeza que deseja excluir esta mensagem?</p>
        <div class="border p-3 rounded bg-light mb-3">
            <strong>Data:</strong> {{ mensagem.WHA_data_criacao|date:"d/m/Y H:i" }}<br>
            <strong>Destinatário:</strong> {{ mensagem.get_WHA_destinatario_tipo_display }}<br>
            <strong>Mensagem:</strong> {{ mensagem.WHA_texto|truncatewords:20|default:"-" }}
        </div>
        <form method="post" action="{% url 'app_igreja:whatsapp_excluir' mensagem.WHA_id %}" onsubmit="return lockFormButtons(this)">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-gravar-global" onclick="lockFormButtons(this)">
                <i class="fas fa-trash me-1"></i>Confirmar Exclusão
            </button>
            <a href="{% url 'app_igreja:whatsapp_list' %}" class="btn btn-secondary btn-cancelar-global">
                <i class="fas fa-times me-1"></i>Cancelar
            </a>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if acao == 'incluir' or acao == 'editar' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Controlar exibição de filtros quando destinatário específico é selecionado
    const dizimistaEspecifico = document.getElementById('id_dizimista_especifico');
    const colaboradorEspecifico = document.getElementById('id_colaborador_especifico');
    const filtrosDizimista = document.getElementById('filtros-dizimista');
    const filtrosColaborador = document.getElementById('filtros-colaborador');
    
    function toggleFiltrosDizimista() {
        if (dizimistaEspecifico && dizimistaEspecifico.value) {
            filtrosDizimista.style.display = 'none';
        } else {
            filtrosDizimista.style.display = 'block';
        }
    }
    
    function toggleFiltrosColaborador() {
        if (colaboradorEspecifico && colaboradorEspecifico.value) {
            filtrosColaborador.style.display = 'none';
        } else {
            filtrosColaborador.style.display = 'block';
        }
    }
    
    if (dizimistaEspecifico) {
        dizimistaEspecifico.addEventListener('change', toggleFiltrosDizimista);
        toggleFiltrosDizimista(); // Executar na carga inicial
    }
    
    if (colaboradorEspecifico) {
        colaboradorEspecifico.addEventListener('change', toggleFiltrosColaborador);
        toggleFiltrosColaborador(); // Executar na carga inicial
    }
    
    // Controlar tipo de destinatário baseado na aba ativa
    const tabs = document.querySelectorAll('#destinatarioTabs button[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const targetId = event.target.getAttribute('data-bs-target');
            // Atualizar campo hidden baseado na aba
            const hiddenInputs = document.querySelectorAll('input[name="tipo_destinatario"]');
            hiddenInputs.forEach(input => input.removeAttribute('name'));
            
            if (targetId === '#dizimista-pane') {
                document.getElementById('tipo_destinatario_dizimista').setAttribute('name', 'tipo_destinatario');
            } else if (targetId === '#colaborador-pane') {
                document.getElementById('tipo_destinatario_colaborador').setAttribute('name', 'tipo_destinatario');
            }
        });
    });
    
    // Controlar formulário de mídia (estilo cortina)
    const tipoMidia = document.getElementById('id_tipo_midia');
    const formularioMidia = document.getElementById('formulario-midia');
    const camposImagem = document.getElementById('campos-imagem');
    const camposAudio = document.getElementById('campos-audio');
    const camposVideo = document.getElementById('campos-video');
    
    function atualizarFormularioMidia() {
        const tipo = tipoMidia.value;
        
        // Ocultar todos os campos primeiro
        if (camposImagem) camposImagem.style.display = 'none';
        if (camposAudio) camposAudio.style.display = 'none';
        if (camposVideo) camposVideo.style.display = 'none';
        
        // Mostrar campos baseado no tipo selecionado
        if (tipo === 'IMAGEM') {
            if (camposImagem) camposImagem.style.display = 'block';
            if (formularioMidia) formularioMidia.style.display = 'block';
        } else if (tipo === 'AUDIO') {
            if (camposAudio) camposAudio.style.display = 'block';
            if (formularioMidia) formularioMidia.style.display = 'block';
        } else if (tipo === 'VIDEO') {
            if (camposVideo) camposVideo.style.display = 'block';
            if (formularioMidia) formularioMidia.style.display = 'block';
        } else {
            if (formularioMidia) formularioMidia.style.display = 'none';
        }
    }
    
    if (tipoMidia) {
        tipoMidia.addEventListener('change', atualizarFormularioMidia);
        atualizarFormularioMidia(); // Executar na carga inicial
    }
    
    // Mudar label do botão "Gravar" para "Enviar" com ícone WhatsApp
    const btnGravar = document.querySelector('button[onclick^="bdGravar"]');
    if (btnGravar) {
        btnGravar.innerHTML = '<i class="fab fa-whatsapp me-2"></i>Enviar';
        btnGravar.classList.remove('btn-warning');
        btnGravar.classList.add('btn-success');
        btnGravar.setAttribute('onclick', 'bdGravar(this)');
    }
    
    // Sobrescrever bdGravar para o botão de enviar
    window.bdGravar = function(btn) {
        const form = document.getElementById('detail-form');
        const btnEnviar = btn || document.querySelector('button[onclick="bdGravar(this)"]');
        
        if (form) {
            if (lockFormButtons(btnEnviar || form)) {
                console.log('Submetendo formulário de envio WhatsApp...');
                form.submit();
            }
        } else {
            console.error('Formulário detail-form não encontrado.');
            alert('Erro: Formulário não encontrado. Por favor, recarregue a página.');
        }
    };
});
</script>
{% endif %}
{% endblock %}
