{% extends "base.html" %}
{% load static %}

{% block title %}Projeto On Crist - Paróquia{% endblock %}

{% block content %}
<!-- Botão Flutuante AO VIVO (YouTube) -->
{% if paroquia.PAR_url_youtube %}
<div id="btn-ao-vivo" class="btn-ao-vivo-container" style="display: none;">
    <button onclick="abrirYouTubeAoVivo()" class="btn-ao-vivo">
        <i class="fas fa-circle me-2"></i>
        <span>AO VIVO</span>
    </button>
</div>

<!-- Modal para exibir vídeo ao vivo -->
<div id="modal-youtube-ao-vivo" class="modal-youtube-container" style="display: none;">
    <div class="modal-youtube-content">
        <div class="modal-youtube-header">
            <h5 class="mb-0">
                <i class="fas fa-video me-2"></i>
                Transmissão ao Vivo
            </h5>
            <button onclick="fecharModalYouTube()" class="btn-close-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-youtube-body">
            <div id="youtube-player-container">
                <iframe id="youtube-live-iframe" 
                        src="" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                </iframe>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Seção de boas-vindas com container verde claro -->
<div class="container-fluid welcome-section py-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6 col-md-5 col-sm-12">
                <h2 class="mb-3 text-dark fw-bold">
                    <i class="fas fa-church text-primary me-2"></i>
                    Paróquia: <span class="paroquia-nome text-primary">{{ paroquia.PAR_nome_paroquia|default:"[Nome da Paróquia]" }}</span>
                </h2>
                <p class="lead mb-2 text-dark">
                    <i class="fas fa-heart text-danger me-2"></i>
                    Bem-vindos à nossa comunidade de fé!
                </p>
                <p class="text-dark fw-bold">
                    Hoje, com a evolução da tecnologia, as informações estão mais fáceis de ser acessadas, distribuídas e divulgadas, 
                    mesmo que muitas dessas informações sejam questionáveis quanto à sua veracidade; isso nos coloca expostos a todo 
                    tipo de informação que nem sempre vai no caminho da legalidade, da ética e, sobretudo, no caminho do SENHOR. 
                    Foi baseado neste contexto que criamos este aplicativo que une tecnologia e fé, uma nova maneira de estarmos 
                    mais próximos aos nossos próximos.
                </p>
            </div>
            <div class="col-lg-6 col-md-7 col-sm-12 text-center">
                {% if visual and visual.VIS_FOTO_PRINCIPAL %}
                    <img src="{{ visual.VIS_FOTO_PRINCIPAL.url }}" alt="Imagem Principal" class="img-fluid catedral-image" style="max-height: 286px; max-width: 100%; min-width: 253px; object-fit: contain;">
                {% else %}
                    <img src="{% static 'img/oncristo2.png' %}" alt="Jesus Cristo com Smartphone" class="img-fluid catedral-image" style="max-height: 286px; max-width: 100%; min-width: 253px; object-fit: contain;">
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Popup de Divulgação (Banners) -->
{% if banners %}
<div id="modal-divulgacao" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #a6e4e9; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); overflow: hidden;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; border-bottom: 1px solid #dee2e6; padding: 15px 20px; background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);">
            <h5 style="margin: 0; font-weight: bold; color: hsl(0, 45%, 74%);">
                <i class="fas fa-bullhorn me-2"></i>Divulgação
            </h5>
            <button type="button" onclick="fecharModalDivulgacao()" style="background: none; border: none; font-size: 24px; font-weight: bold; color: white; cursor: pointer; padding: 0; width: 30px; height: 30px; line-height: 24px;">&times;</button>
        </div>
        <div style="padding: 20px;">
            <div class="row g-3">
                <div class="col-md-4">
                    <img id="popup-banner-imagem" src="" alt="Banner" class="img-fluid h-100" style="object-fit: cover; min-height: 200px; width: 100%; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>
                <div class="col-md-8">
                    <div style="padding: 20px; background: linear-gradient(135deg, #13af20 0%, #e9ecef 100%); border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); height: 100%;">
                        <div style="background: rgb(241, 222, 185); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 1px 4px rgba(0,0,0,0.05);">
                            <h4 id="popup-banner-titulo" class="text-primary mb-2" style="font-weight: bold; margin: 0;"></h4>
                        </div>
                        <p id="popup-banner-descricao" class="text-muted mb-3" style="line-height: 1.6;"></p>
                        <div id="popup-banner-info" class="row text-muted small mb-3" style="background: rgb(236, 152, 204); padding: 12px; border-radius: 10px; margin: 0;">
                            <!-- Informações do patrocinador -->
                        </div>
                        <div class="mt-3">
                            <a id="popup-banner-link" href="#" class="btn btn-primary btn-sm" target="_blank" style="display: none; border-radius: 8px;">
                                <i class="fas fa-external-link-alt"></i> Visitar Site
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% if banners|length > 1 %}
            <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                <div class="btn-group btn-group-sm" role="group">
                    {% for banner in banners %}
                        <button type="button" class="btn btn-outline-primary popup-banner-indicator" data-banner="{{ forloop.counter0 }}" style="margin: 0 2px;">
                            <i class="fas fa-circle"></i>
                        </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!#########################################
Seção de Informações e Serviços
#########################################>
<div class="container py-5">
    <div class="row g-4">
        <!-- Informações -->
        <div class="col-lg-6 col-md-12">
            <div class="card h-100 shadow-sm border-0" style="background: linear-gradient(135deg, #cfe2ff 0%, #b6d4fe 50%, #9ec5fe 100%) !important;">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações
                    </h4>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="abrirHorarios()">
                            <i class="fas fa-church me-3 text-primary"></i>
                            <div>
                                <h6 class="mb-1">Horários de Missas</h6>
                                <small class="text-muted">Horários e celebrações</small>
                            </div>
                        </a>
                        <!-- Contato -->
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="abrirContato()">
                            <i class="fas fa-phone-alt me-3 text-success"></i>
                            <div>
                                <h6 class="mb-1">Contato</h6>
                                <small class="text-muted">Fale conosco</small>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="abrirLiturgia()">
                            <i class="fas fa-bible me-3 text-info"></i>
                            <div>
                                <h6 class="mb-1">Liturgia Diária</h6>
                                <small class="text-muted">Fonte de vida</small>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="abrirAniversariantes()">
                            <i class="fas fa-birthday-cake me-3 text-pink"></i>
                            <div>
                                <h6 class="mb-1">Aniversariantes do Mês</h6>
                                <small class="text-muted">Celebrações do mês</small>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="abrirEventos()">
                            <i class="fas fa-calendar-alt me-3 text-warning"></i>
                            <div>
                                <h6 class="mb-1">Calendário de Eventos</h6>
                                <small class="text-muted">Programação da paróquia</small>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <!#########################################
        <!-- SERVICOS -->
        <!#########################################>
        <div class="col-lg-6 col-md-12">
            <div class="card h-100 shadow-sm border-0" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 50%, #b1dfbb 100%) !important;">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-hands-helping me-2"></i>
                        Serviços
                    </h4>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="abrirIntencoes()">
                            <i class="fas fa-fan me-3 text-info"></i>
                            <div>
                                <h6 class="mb-1">Celebrações Agendadas</h6>
                                <small class="text-muted">Consulte suas celebrações agendadas</small>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="abrirDizimista()">
                            <i class="fas fa-hands-helping me-3 text-success"></i>
                            <div>
                                <h6 class="mb-1">Quero ser Dizimista</h6>
                                <small class="text-muted">Junte-se à nossa comunidade de fé e amor</small>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="abrirAvisos()">
                            <i class="fas fa-bullhorn me-3 text-primary"></i>
                            <div>
                                <h6 class="mb-1">Avisos da Paróquia</h6>
                                <small class="text-muted">Confere a agenda Paroquial</small>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="abrirDoacoes()">
                            <i class="fas fa-hand-holding-heart me-3 text-success"></i>
                            <div>
                                
                                
                                <small class="text-muted">PIX, Cartões ou Boleto</small>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" onclick="abrirPedidosOracao()">
                            <i class="fas fa-pray me-3 text-primary"></i>
                            <div>
                                <h6 class="mb-1">Pedidos de Orações</h6>
                                <small class="text-muted">Orações, Agradecimentos, Louvores...</small>
                            </div>
                        </a>
                        
                </div>
            </div>
        </div>
    </div>
</div>
<!#########################################
# FINAL DA SEÇÃO DE INFORMAÇÕES E SERVIÇOS
#########################################>

<!#########################################
# Seção de Mural de Fotos
#########################################>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%) !important;">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-images me-2"></i>
                        Mural de Fotos
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-center text-muted mb-4">
                        Confira os momentos especiais da nossa comunidade!
                    </p>
                    <div class="row g-3 mb-4">
                        {% for mural in murais_recentes %}
                        <div class="col-md-4">
                            {% if mural.MUR_foto1_mural %}
                            <a href="{% url 'app_igreja:mural_publico' mural.MUR_ID %}" style="text-decoration: none; display: block;">
                                <img src="{{ mural.MUR_foto1_mural.url }}" alt="{{ mural.MUR_titulo_mural }}" class="img-fluid rounded shadow-sm" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <p class="text-center mt-2 text-muted small">{{ mural.MUR_titulo_mural }}</p>
                            </a>
                            {% else %}
                            <div class="bg-light rounded shadow-sm d-flex align-items-center justify-content-center" style="height: 200px;">
                                <span class="text-muted">Sem foto</span>
                            </div>
                            {% endif %}
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <p class="text-center text-muted">Nenhum mural disponível no momento.</p>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mb-3">
                        <button class="btn btn-warning" onclick="buscarMural()">
                            <i class="fas fa-search me-1"></i>
                            Buscar
                        </button>
                    </div>
                    <div id="mural-resultados" class="mt-4">
                        <!-- Resultados da busca serão carregados aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!#########################################
# Seção Redes Sociais - SIGA-NOS
#########################################>
{% if paroquia.PAR_url_youtube or paroquia.PAR_url_facebook or paroquia.PAR_url_instagram %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card shadow-sm border-0" style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 50%, #f1b0b7 100%) !important;">
                <div class="card-header text-center" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white;">
                    <h4 class="mb-0">
                        <i class="fas fa-share-alt me-2"></i>
                        SIGA-NOS
                    </h4>
                </div>
                <div class="card-body p-3">
                    <div class="d-flex flex-column gap-2">
                        {% if paroquia.PAR_url_youtube %}
                        <a href="{{ paroquia.PAR_url_youtube }}" target="_blank" rel="noopener noreferrer" 
                           class="btn btn-block d-flex align-items-center justify-content-center social-btn-youtube"
                           style="background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%); color: white; border: none; padding: 8px 15px; border-radius: 8px; text-decoration: none; transition: all 0.3s ease;">
                            <i class="fab fa-youtube me-2" style="font-size: 1.2rem;"></i>
                            <div class="text-start">
                                <div class="fw-bold" style="font-size: 0.95rem;">YouTube</div>
                                <small style="opacity: 0.9; font-size: 0.75rem;">Missas ao Vivo</small>
                            </div>
                        </a>
                        {% endif %}
                        
                        {% if paroquia.PAR_url_facebook %}
                        <a href="{{ paroquia.PAR_url_facebook }}" target="_blank" rel="noopener noreferrer" 
                           class="btn btn-block d-flex align-items-center justify-content-center social-btn-facebook"
                           style="background: linear-gradient(135deg, #1877f2 0%, #0d5dbf 100%); color: white; border: none; padding: 8px 15px; border-radius: 8px; text-decoration: none; transition: all 0.3s ease;">
                            <i class="fab fa-facebook me-2" style="font-size: 1.2rem;"></i>
                            <div class="text-start">
                                <div class="fw-bold" style="font-size: 0.95rem;">Facebook</div>
                                <small style="opacity: 0.9; font-size: 0.75rem;">Nossa Página</small>
                            </div>
                        </a>
                        {% endif %}
                        
                        {% if paroquia.PAR_url_instagram %}
                        <a href="{{ paroquia.PAR_url_instagram }}" target="_blank" rel="noopener noreferrer" 
                           class="btn btn-block d-flex align-items-center justify-content-center social-btn-instagram"
                           style="background: linear-gradient(135deg, #e4405f 0%, #c13584 50%, #833ab4 100%); color: white; border: none; padding: 8px 15px; border-radius: 8px; text-decoration: none; transition: all 0.3s ease;">
                            <i class="fab fa-instagram me-2" style="font-size: 1.2rem;"></i>
                            <div class="text-start">
                                <div class="fw-bold" style="font-size: 0.95rem;">Instagram</div>
                                <small style="opacity: 0.9; font-size: 0.75rem;">Siga-nos</small>
                            </div>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- CSS para Banners Rotativos -->
<style>
.banner-container {
    position: relative;
    min-height: 200px;
}

.banner-item {
    display: block;
    opacity: 0;
    transition: opacity 0.5s ease;
}

.banner-item.active {
    opacity: 1;
}

.banner-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
}

.banner-indicators {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
}

.banner-indicator.active {
    background-color: #0d6efd !important;
    border-color: #0d6efd !important;
    color: white !important;
}

.banner-indicator {
    transition: all 0.3s ease;
}

.banner-indicator:hover {
    transform: scale(1.1);
}

/* Estilos para botões de redes sociais */
.social-btn-youtube:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(255, 0, 0, 0.4);
    background: linear-gradient(135deg, #ff1a1a 0%, #e60000 100%) !important;
}

.social-btn-facebook:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(24, 119, 242, 0.4);
    background: linear-gradient(135deg, #1a86ff 0%, #0e6ae6 100%) !important;
}

.social-btn-instagram:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(228, 64, 95, 0.4);
    background: linear-gradient(135deg, #f56040 0%, #d42a6a 50%, #9d3ab4 100%) !important;
}

/* Botão Flutuante AO VIVO */
.btn-ao-vivo-container {
    position: fixed !important;
    top: 80px;
    right: 20px;
    z-index: 9999 !important;
    display: block !important;
}

.btn-ao-vivo {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 25px;
    font-weight: bold;
    font-size: 0.9rem;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    cursor: pointer;
    display: flex !important;
    align-items: center;
    transition: all 0.3s ease;
    animation: piscar 2s infinite;
    white-space: nowrap;
}

.btn-ao-vivo:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
}

.btn-ao-vivo:active {
    transform: scale(0.95);
}

.btn-ao-vivo i {
    font-size: 0.7rem;
    animation: pulso 1.5s infinite;
}

@keyframes piscar {
    0%, 100% {
        opacity: 1;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }
    50% {
        opacity: 0.8;
        box-shadow: 0 4px 20px rgba(40, 167, 69, 0.7);
    }
}

@keyframes pulso {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.3;
    }
}

/* Modal YouTube ao Vivo */
.modal-youtube-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 10000 !important;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal-youtube-content {
    background: white;
    border-radius: 15px;
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.modal-youtube-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border-radius: 15px 15px 0 0;
}

.modal-youtube-header h5 {
    margin: 0;
    font-weight: bold;
}

.btn-close-modal {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.btn-close-modal:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.modal-youtube-body {
    padding: 0;
    flex: 1;
    overflow: hidden;
}

#youtube-player-container {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    height: 0;
    overflow: hidden;
}

#youtube-live-iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}

/* Responsivo - ajustar posição em telas menores */
@media (max-width: 768px) {
    .btn-ao-vivo-container {
        top: 60px !important;
        right: 10px !important;
        z-index: 9999 !important;
    }
    
    .btn-ao-vivo {
        padding: 10px 16px;
        font-size: 0.8rem;
    }
    
    .modal-youtube-container {
        padding: 10px;
    }
    
    .modal-youtube-content {
        max-height: 95vh;
    }
    
    .modal-youtube-header {
        padding: 12px 15px;
    }
    
    .modal-youtube-header h5 {
        font-size: 1rem;
    }
}
</style>

<!-- JavaScript para funcionalidades da página -->
<script>
// Funções placeholder para links comentados
function abrirHorarios() {
    // Redireciona para a página de horários de missas
    window.location.href = '/app_igreja/horarios-missas/';
}

function abrirContato() {
    window.location.href = '/app_igreja/contatos/?t=' + Date.now();
}

function abrirLiturgia() {
    // Redireciona para a área pública de liturgias
    window.location.href = '/app_igreja/liturgias/';
}

function abrirAniversariantes() {
    // Redireciona para a página de aniversariantes do mês
    window.location.href = '/app_igreja/aniversariantes-mes/';
}

function abrirEventos() {
    // Redireciona para a página de calendário de eventos
    window.location.href = '/app_igreja/calendario-eventos/';
}

function abrirIntencoes() {
    // Redireciona para a página de agendamento de celebrações
    window.location.href = '/app_igreja/agendar-celebracaoes/';
}

function abrirDizimista() {
    // Redireciona para a página de cadastro público de dizimistas
    window.location.href = '/app_igreja/quero-ser-dizimista/';
}

function abrirAvisos() {
    // Redireciona para a página de avisos da paróquia
    window.location.href = '/app_igreja/avisos-paroquia/';
}

function abrirDoacoes() {
    // Redireciona para a página de doações
    window.location.href = '/app_igreja/doacoes/';
}

function abrirPedidosOracao() {
    // Redireciona para a página de consulta de pedidos de orações
    window.location.href = '/app_igreja/meus-pedidos-oracoes/';
}

function abrirDivulgacao() {
    // Redireciona para a área administrativa de banners/divulgação
    window.location.href = '/app_igreja/admin-area/banners/';
}

function buscarMural() {
    alert('Funcionalidade de Busca no Mural será implementada em breve!');
}

// Função para abrir YouTube ao vivo (modal)
function abrirYouTubeAoVivo() {
    {% if paroquia.PAR_url_youtube %}
    const modal = document.getElementById('modal-youtube-ao-vivo');
    const iframe = document.getElementById('youtube-live-iframe');
    const youtubeUrl = '{{ paroquia.PAR_url_youtube|escapejs }}';
    
    if (!modal || !iframe) return;
    
    // Converter URL do canal para URL de embed ao vivo
    // Se for URL do canal, tentar encontrar vídeo ao vivo
    let embedUrl = youtubeUrl;
    
    // Se for URL do canal, tentar converter para embed
    if (youtubeUrl.includes('/@')) {
        // Para canais com @username, vamos abrir a página do canal
        embedUrl = youtubeUrl.replace('/@', '/embed/live_stream?channel=');
    } else if (youtubeUrl.includes('/channel/')) {
        const channelId = youtubeUrl.split('/channel/')[1].split('/')[0];
        embedUrl = `https://www.youtube.com/embed/live_stream?channel=${channelId}`;
    } else if (youtubeUrl.includes('/c/')) {
        // Para canais customizados, vamos tentar abrir a página do canal
        embedUrl = youtubeUrl;
    }
    
    // Se não conseguir converter, usar a URL original
    iframe.src = embedUrl;
    modal.style.display = 'flex';
    
    // Prevenir scroll do body quando modal estiver aberto
    document.body.style.overflow = 'hidden';
    {% endif %}
}

// Função para fechar modal YouTube
function fecharModalYouTube() {
    const modal = document.getElementById('modal-youtube-ao-vivo');
    const iframe = document.getElementById('youtube-live-iframe');
    
    if (modal) {
        modal.style.display = 'none';
    }
    
    if (iframe) {
        iframe.src = ''; // Pausar vídeo ao fechar
    }
    
    // Restaurar scroll do body
    document.body.style.overflow = '';
}

// Fechar modal ao clicar fora
document.addEventListener('click', function(event) {
    const modal = document.getElementById('modal-youtube-ao-vivo');
    if (modal && event.target === modal) {
        fecharModalYouTube();
    }
});

// Fechar modal com ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        fecharModalYouTube();
    }
});

// Verificar se há transmissão ao vivo no YouTube
{% if paroquia.PAR_url_youtube %}
function verificarTransmissaoAoVivo() {
    const btnAoVivo = document.getElementById('btn-ao-vivo');
    
    if (!btnAoVivo) return;
    
    // Verificar via API se há transmissão ao vivo
    fetch('/app_igreja/api/youtube/verificar-ao-vivo/')
        .then(response => response.json())
        .then(data => {
            // Por enquanto, vamos mostrar o botão sempre que houver URL do YouTube
            // Em produção, você pode usar a API do YouTube Data API v3 para verificar realmente
            
            // Exemplo de verificação real (requer API key do YouTube):
            /*
            const channelId = data.canal_info?.id;
            const apiKey = 'SUA_API_KEY_AQUI';
            
            if (channelId && apiKey) {
                fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&eventType=live&type=video&key=${apiKey}`)
                    .then(response => response.json())
                    .then(youtubeData => {
                        if (youtubeData.items && youtubeData.items.length > 0) {
                            btnAoVivo.style.display = 'block';
                        } else {
                            btnAoVivo.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao verificar transmissão ao vivo:', error);
                        btnAoVivo.style.display = 'none';
                    });
            }
            */
            
            // Por enquanto, mostrar o botão sempre que houver URL do YouTube
            // Você pode descomentar o código acima quando tiver API key do YouTube
            btnAoVivo.style.display = 'block';
        })
        .catch(error => {
            console.error('Erro ao verificar transmissão ao vivo:', error);
            btnAoVivo.style.display = 'none';
        });
}

// Verificar imediatamente ao carregar a página e depois a cada 2 minutos
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(verificarTransmissaoAoVivo, 1000);
        setInterval(verificarTransmissaoAoVivo, 120000); // A cada 2 minutos
    });
} else {
    setTimeout(verificarTransmissaoAoVivo, 1000);
    setInterval(verificarTransmissaoAoVivo, 120000); // A cada 2 minutos
}
{% endif %}

{% if banners %}
// Dados dos banners
const bannerDados = [
    {% for banner in banners %}
    {
        titulo: "{{ banner.BAN_NOME_PATROCINADOR|escapejs }}",
        descricao: "{{ banner.BAN_DESCRICAO_COMERCIAL|default:''|escapejs }}",
        imagem: "{% if banner.BAN_IMAGE %}{{ banner.BAN_IMAGE.url }}{% endif %}",
        link: "{{ banner.BAN_LINK|default:'#' }}",
        telefone: "{{ banner.BAN_TELEFONE|default:''|escapejs }}",
        endereco: "{{ banner.BAN_ENDERECO|default:''|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

let popupBannerIdx = 0;
let popupBannerTimer = null;

// Função para mostrar banner no popup
function mostrarPopupBanner() {
    if (bannerDados.length === 0) return;
    
    const b = bannerDados[popupBannerIdx];
    const img = document.getElementById('popup-banner-imagem');
    const titulo = document.getElementById('popup-banner-titulo');
    const desc = document.getElementById('popup-banner-descricao');
    const info = document.getElementById('popup-banner-info');
    const link = document.getElementById('popup-banner-link');
    
    if (img) img.src = b.imagem;
    if (titulo) {
        titulo.innerHTML = '<i class="fas fa-store me-2"></i>' + b.titulo;
    }
    if (desc) desc.textContent = b.descricao;
    
    if (info) {
        info.innerHTML = '';
        if (b.telefone) info.innerHTML += '<div class="col-6"><i class="fas fa-phone"></i> ' + b.telefone + '</div>';
        if (b.endereco) info.innerHTML += '<div class="col-6"><i class="fas fa-map-marker-alt"></i> ' + b.endereco + '</div>';
    }
    
    if (link) {
        if (b.link && b.link !== '#') {
            link.href = b.link;
            link.style.display = 'inline-block';
        } else {
            link.style.display = 'none';
        }
    }
    
    // Atualizar indicadores
    document.querySelectorAll('.popup-banner-indicator').forEach((el, i) => {
        if (i === popupBannerIdx) {
            el.classList.add('active');
            el.style.backgroundColor = '#0d6efd';
            el.style.borderColor = '#0d6efd';
            el.style.color = 'white';
        } else {
            el.classList.remove('active');
            el.style.backgroundColor = '';
            el.style.borderColor = '';
            el.style.color = '';
        }
    });
}

// Função para próximo banner
function proximoPopupBanner() {
    popupBannerIdx = (popupBannerIdx + 1) % bannerDados.length;
    mostrarPopupBanner();
}

// Função para iniciar rotação
function iniciarRotacaoPopup() {
    if (popupBannerTimer) clearInterval(popupBannerTimer);
    popupBannerTimer = setInterval(proximoPopupBanner, 5000);
}

// Função para parar rotação
function pararRotacaoPopup() {
    if (popupBannerTimer) {
        clearInterval(popupBannerTimer);
        popupBannerTimer = null;
    }
}

// Função para abrir modal
function abrirModalDivulgacao() {
    const modal = document.getElementById('modal-divulgacao');
    if (modal && bannerDados.length > 0) {
        popupBannerIdx = 0;
        mostrarPopupBanner();
        modal.style.display = 'block';
        iniciarRotacaoPopup();
    }
}

// Função para fechar modal
function fecharModalDivulgacao() {
    const modal = document.getElementById('modal-divulgacao');
    if (modal) {
        modal.style.display = 'none';
        pararRotacaoPopup();
    }
}

// Fechar modal ao clicar fora
window.addEventListener('click', function(event) {
    const modal = document.getElementById('modal-divulgacao');
    if (modal && event.target == modal) {
        fecharModalDivulgacao();
    }
});

// Inicializar quando página carregar
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        if (bannerDados.length > 0) {
            abrirModalDivulgacao();
        }
        
        // Event listeners para indicadores
        document.querySelectorAll('.popup-banner-indicator').forEach((el, i) => {
            el.onclick = function() {
                popupBannerIdx = i;
                mostrarPopupBanner();
                pararRotacaoPopup();
                iniciarRotacaoPopup();
            };
        });
    });
} else {
    if (bannerDados.length > 0) {
        abrirModalDivulgacao();
    }
    
    // Event listeners para indicadores
    document.querySelectorAll('.popup-banner-indicator').forEach((el, i) => {
        el.onclick = function() {
            popupBannerIdx = i;
            mostrarPopupBanner();
            pararRotacaoPopup();
            iniciarRotacaoPopup();
        };
    });
}
{% endif %}
</script>

{% endblock %}